<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球战略指挥系统 // 启动程序</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-green: #00ff9d;
            --dim-green: #0f392b;
            --bg-dark: #020604;
            --grid-line: rgba(0, 255, 157, 0.08);
            --panel-bg: rgba(2, 10, 5, 0.95);
            --highlight: #ffffff;
            --danger: #ff3366;
            --score-gold: #ffae00;
            --locked-gray: #333333;
            --intel-blue: #00ccff;
            --market-purple: #d946ef;
            --ops-red: #ff3333;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-dark);
            font-family: 'Share Tech Mono', monospace;
            color: var(--primary-green);
            user-select: none;
        }

        /* ================= 地图样式 ================= */
        #map-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 40px 40px;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
            z-index: 0;
            transition: filter 0.5s;
        }
        
        body.setup-mode #map-container { filter: blur(4px) brightness(0.5); }

        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 1;
            opacity: 0.3;
        }

        .region {
            stroke: var(--primary-green);
            stroke-width: 1px;
            stroke-opacity: 0.3;
            stroke-linejoin: round;
            transition: all 0.3s;
            cursor: pointer;
            fill-opacity: 0.2;
        }

        body.placement-mode .region:not(.target-region) {
            fill-opacity: 0.05;
            stroke-opacity: 0.1;
            cursor: not-allowed;
        }
        
        body.placement-mode .region.target-region {
            fill: var(--primary-green);
            fill-opacity: 0.3;
            stroke: #fff;
            stroke-width: 2px;
            stroke-dasharray: 10 5;
            animation: map-pulse 2s infinite;
            cursor: crosshair;
        }
        
        body.branch-mode .region {
            fill: var(--primary-green);
            fill-opacity: 0.1;
            cursor: crosshair;
        }
        body.branch-mode .region:hover {
            fill-opacity: 0.4;
            stroke: #fff;
        }

        @keyframes map-pulse {
            0% { fill-opacity: 0.2; }
            50% { fill-opacity: 0.4; }
            100% { fill-opacity: 0.2; }
        }

        .tech-node-pulse {
            fill: none;
            stroke: var(--primary-green);
            stroke-width: 1.5px;
            opacity: 0;
            transform-origin: center;
            animation: radar-pulse 2s infinite;
        }
        @keyframes radar-pulse {
            0% { r: 2; opacity: 1; stroke-width: 2px; }
            100% { r: 15; opacity: 0; stroke-width: 0px; }
        }
        
        .player-node-pulse { stroke: #ffae00; }
        .player-node-circle { fill: #ffae00; stroke: #fff; stroke-width: 2px; }
        .branch-node-pulse { stroke: #00ccff; }
        .branch-node-circle { fill: #00ccff; stroke: #fff; stroke-width: 2px; }

        /* ================= UI 基础 ================= */
        .game-ui { display: none; opacity: 0; transition: opacity 1s; }
        .game-ui.active { display: block; opacity: 1; }

        .news-ticker-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 36px;
            background: var(--panel-bg);
            border-bottom: 1px solid rgba(0, 255, 157, 0.3);
            z-index: 50;
            display: flex; align-items: center; overflow: hidden; white-space: nowrap;
        }
        .news-label {
            background: var(--primary-green); color: #000; padding: 0 12px; height: 100%;
            display: flex; align-items: center; font-weight: bold; font-size: 14px; z-index: 51;
        }
        .news-content {
            display: inline-block;
            color: #a3e6c7; font-size: 14px;
            white-space: nowrap;
            /* Animation applied via JS class to allow reset */
        }
        .news-content.scrolling {
            padding-left: 100%;
            animation: ticker 30s linear infinite;
        }
        @keyframes ticker { 100% { transform: translate(-100%, 0); } }

        .bottom-menu-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 64px;
            background: linear-gradient(to top, rgba(0,10,5,1), rgba(0,10,5,0.8));
            border-top: 1px solid var(--primary-green);
            z-index: 50;
            display: flex; justify-content: center; align-items: center; gap: 2px; padding: 0 20px;
        }
        .menu-btn {
            background: rgba(0, 255, 157, 0.05);
            border: 1px solid rgba(0, 255, 157, 0.2);
            color: var(--primary-green);
            padding: 0 24px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-family: 'Share Tech Mono'; font-size: 14px;
            transition: all 0.2s; min-width: 120px;
        }
        .menu-btn:hover {
            background: rgba(0, 255, 157, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 0 10px var(--primary-green);
        }
        .btn-primary {
            background: var(--primary-green); color: #000; font-weight: bold;
        }
        .btn-primary:hover {
            background: #fff;
            box-shadow: 0 0 15px var(--primary-green);
        }

        /* ================= 侧边面板 ================= */
        .overlay-panel {
            position: absolute; inset: 0; z-index: 100;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            transition: opacity 0.5s;
        }
        
        .side-window {
            position: absolute;
            top: 36px; bottom: 64px; right: -600px; width: 550px;
            background: rgba(5, 15, 10, 0.98);
            border-left: 1px solid var(--primary-green);
            box-shadow: -10px 0 30px rgba(0,0,0,0.8);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 60;
            display: flex; flex-direction: column;
        }
        .side-window.open { right: 0; }

        #intel-window { border-left-color: var(--intel-blue); }
        #intel-window h2 { color: var(--intel-blue); }
        
        /* Market Window Styles Enhanced */
        #market-window { 
            border-left: 2px solid var(--market-purple); 
            background: linear-gradient(180deg, rgba(20, 5, 20, 0.98) 0%, rgba(5, 5, 5, 0.99) 100%);
        }
        #market-window h2 { 
            color: var(--market-purple); 
            text-shadow: 0 0 10px rgba(217, 70, 239, 0.4);
        }
        .market-ranking-row {
            display: flex; align-items: center; padding: 10px; 
            border-bottom: 1px solid rgba(217, 70, 239, 0.15);
            transition: background 0.2s;
        }
        .market-ranking-row:hover { background: rgba(217, 70, 239, 0.05); }
        .rank-num { 
            width: 30px; font-weight: bold; font-size: 16px; color: #666; 
            text-align: center; margin-right: 10px; 
        }
        .rank-num.top-1 { color: #ffae00; text-shadow: 0 0 5px #ffae00; }
        .rank-num.top-2 { color: #ccc; }
        .rank-num.top-3 { color: #b08d55; }

        /* 新增：秘密行动窗口样式 */
        #ops-window { border-left-color: var(--ops-red); }
        #ops-window h2 { color: var(--ops-red); }

        .setup-panel {
            width: 900px; max-width: 95vw;
            background: rgba(5, 15, 10, 0.95);
            border: 1px solid var(--primary-green);
            box-shadow: 0 0 50px rgba(0, 255, 157, 0.1);
            display: grid; grid-template-columns: 300px 1fr;
            height: 600px; position: relative;
        }

        .corner-deco { position: absolute; width: 10px; height: 10px; border: 2px solid var(--primary-green); }
        .tl { top: -2px; left: -2px; border-right: 0; border-bottom: 0; }
        .tr { top: -2px; right: -2px; border-left: 0; border-bottom: 0; }
        .bl { bottom: -2px; left: -2px; border-right: 0; border-top: 0; }
        .br { bottom: -2px; right: -2px; border-left: 0; border-top: 0; }

        h2 { font-size: 24px; margin-bottom: 20px; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        input[type="text"], input[type="number"] {
            width: 100%; background: #000; border: 1px solid #333;
            color: #fff; padding: 10px; font-family: 'Share Tech Mono';
            font-size: 16px; outline: none;
        }
        input[type="text"]:focus, input[type="number"]:focus { border-color: var(--primary-green); }

        input[type="range"] {
            width: 100%; -webkit-appearance: none; background: transparent;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            border-radius: 50%; background: var(--primary-green);
            margin-top: -5px; cursor: pointer; box-shadow: 0 0 5px var(--primary-green);
            border: 2px solid #fff;
        }
        
        .tabs { display: flex; border-bottom: 1px solid #333; }
        .tab-btn {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            color: #888; border-bottom: 2px solid transparent; font-size: 12px;
        }
        .tab-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tab-btn.active {
            color: var(--primary-green); border-bottom-color: var(--primary-green);
            background: rgba(0,255,157,0.05);
        }

        #intel-tabs .tab-btn.active {
            color: var(--intel-blue); border-bottom-color: var(--intel-blue);
            background: rgba(0, 204, 255, 0.05);
        }

        .tech-row { display: flex; align-items: center; margin-bottom: 20px; }
        .tech-label { width: 100px; font-size: 12px; color: #888; text-align: right; padding-right: 15px; }
        .tech-track { flex: 1; display: flex; gap: 10px; position: relative; }
        .tech-track::before { 
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 2px; 
            background: #333; z-index: 0; 
        }
        .tech-node-btn {
            width: 60px; height: 40px; background: #111; border: 1px solid #444; z-index: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; transition: all 0.2s;
        }
        .tech-node-btn.unlocked {
            background: rgba(0,255,157,0.1); border-color: var(--primary-green); color: white;
        }
        .tech-node-btn.next-unlock {
            background: #222; border-color: #ffff00; color: #ffff00;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.2);
        }
        .tech-node-btn.locked {
            background: #000; border-color: #222; color: #444; cursor: not-allowed;
        }
        .tech-node-btn.selected-node {
            border-color: #fff; box-shadow: 0 0 15px white;
        }
        
        .node-cap { font-size: 14px; font-weight: bold; }
        .node-cost { font-size: 11px; margin-top: 2px; }

        .chain-card {
            border: 1px solid #333; padding: 15px; cursor: pointer;
            margin-bottom: 15px; opacity: 0.6; transition: all 0.2s;
        }
        .chain-card.selected {
            border-color: var(--primary-green); background: rgba(0, 255, 157, 0.05); opacity: 1;
        }
        
        .region-select-btn {
            display: block; width: 100%; padding: 10px; margin-bottom: 5px;
            background: transparent; border: 1px solid transparent; color: #888; text-align: left;
        }
        .region-select-btn.active {
            border: 1px solid var(--primary-green); color: var(--primary-green); background: rgba(0, 255, 157, 0.1);
        }

        #start-btn {
            width: 100%; padding: 15px; margin-top: 20px;
            background: var(--primary-green); color: #000; border: none;
            font-weight: bold; font-family: 'Share Tech Mono'; font-size: 18px;
            cursor: pointer; opacity: 0.5; pointer-events: none;
        }
        #start-btn.ready { opacity: 1; pointer-events: all; box-shadow: 0 0 20px var(--primary-green); }

        #tooltip {
            position: absolute; padding: 12px; background: rgba(2, 10, 5, 0.95);
            border: 1px solid var(--primary-green); color: var(--primary-green);
            pointer-events: none; font-size: 14px; box-shadow: 0 0 15px rgba(0, 255, 157, 0.3);
            opacity: 0; transition: opacity 0.1s; z-index: 200; min-width: 180px;
        }

        /* 放置提示 */
        #placement-hint {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); border: 1px solid var(--primary-green);
            padding: 20px 40px; z-index: 90; display: none; text-align: center;
        }

        /* 市场份额条形图 */
        .market-bar-container {
            width: 100%; height: 24px; background: #111; display: flex; margin-bottom: 8px; border: 1px solid #333;
        }
        .market-bar-segment {
            height: 100%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: #000; font-weight: bold; overflow: hidden; white-space: nowrap;
            transition: width 0.5s;
        }
        
        /* 企业列表项 */
        .company-item {
            padding: 10px; border-bottom: 1px solid #222; cursor: pointer; transition: background 0.2s;
        }
        .company-item:hover { background: rgba(255,255,255,0.05); }
        .company-item.active { background: rgba(0, 204, 255, 0.1); border-left: 2px solid var(--intel-blue); }
        
        .spec-comparison-row {
            display: flex; align-items: center; margin-bottom: 4px; font-size: 12px;
        }
        .spec-label { width: 80px; color: #888; text-align: right; margin-right: 10px; }
        .spec-bar-bg { flex: 1; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .spec-bar-fill { height: 100%; background: var(--intel-blue); }
        .spec-val { width: 30px; text-align: right; color: #fff; margin-left: 5px; }

        /* Chart */
        #valuation-chart { width: 100%; height: 150px; background: #111; border: 1px solid #333; }

        /* ================= 秘密行动特定样式 ================= */
        .op-card {
            position: relative;
            background: linear-gradient(45deg, rgba(20,0,0,0.9), rgba(40,0,0,0.8));
            border: 1px solid rgba(255, 51, 102, 0.3);
            padding: 15px; margin-bottom: 12px;
            transition: all 0.3s;
            overflow: hidden;
            cursor: pointer;
        }
        .op-card:hover {
            border-color: var(--ops-red);
            box-shadow: 0 0 15px rgba(255, 51, 102, 0.2);
            transform: translateX(5px);
        }
        .op-card:hover::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--ops-red);
        }
        .op-badge {
            font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 2px;
            margin-right: 5px; display: inline-block;
        }
        .badge-rival { background: rgba(255, 51, 102, 0.2); color: var(--ops-red); border: 1px solid var(--ops-red); }
        .badge-upstream { background: rgba(255, 174, 0, 0.2); color: #ffae00; border: 1px solid #ffae00; }
        .badge-downstream { background: rgba(0, 204, 255, 0.2); color: #00ccff; border: 1px solid #00ccff; }
        
        .ops-console {
            background: #050101; border: 1px solid var(--ops-red); padding: 10px;
            font-family: 'Courier New', Courier, monospace; font-size: 12px; color: var(--ops-red);
            height: 120px; overflow-y: auto; text-shadow: 0 0 2px var(--ops-red);
        }
        .console-line { margin-bottom: 4px; opacity: 0.8; }
        .console-line.success { color: #00ff9d; text-shadow: 0 0 2px #00ff9d; }
        .console-line.fail { color: #ff0000; font-weight: bold; }

    </style>
</head>
<body class="setup-mode">

    <div class="scanline"></div>

    <div class="game-ui">
        <div class="news-ticker-container">
            <div class="news-label">GLOBAL_FEED //</div>
            <div class="news-content" id="news-content"></div>
        </div>

        <div class="absolute top-[60px] left-5 z-40 pointer-events-none">
            <div class="text-2xl font-bold text-white tracking-widest"><span id="hud-company-name">UNKNOWN</span> <span class="text-[var(--primary-green)]">CORP</span></div>
            <div class="text-xs text-green-400 opacity-70 mt-1">// SECTOR: <span id="hud-sector">--</span> // REGION: <span id="hud-region">--</span></div>
            <div class="text-lg font-bold text-white mt-2 border-t border-green-900/50 pt-1" id="date-display">2030-01</div>
        </div>

        <div class="absolute top-[60px] right-5 z-40">
            <div class="border border-green-500/30 bg-black/80 p-3 text-right">
                <div class="text-xs text-gray-400">CASH RESERVES</div>
                <div class="text-xl text-white font-bold">$<span id="cash-display">--</span> B</div>
                <div class="text-[10px] text-green-500" id="profit-display">+0.0 B / month</div>
            </div>
        </div>

        <div class="bottom-menu-bar">
            <button class="menu-btn" onclick="toggleIntelWindow()">全球情报<br><span class="text-[10px] opacity-50">INTEL</span></button>
            <button class="menu-btn" onclick="toggleTechWindow()">核心研发<br><span class="text-[10px] opacity-50">R&D LAB</span></button>
            <button class="menu-btn" onclick="toggleMarketWindow()">资本运作<br><span class="text-[10px] opacity-50">MARKET</span></button>
            <button class="menu-btn" style="color: var(--ops-red); border-color:rgba(255,51,102,0.3);" onclick="toggleOpsWindow()">秘密行动<br><span class="text-[10px] opacity-50">BLACK OPS</span></button>
            <div class="w-px h-8 bg-green-800 mx-2"></div>
            <button class="menu-btn btn-primary border-green-500" onclick="toggleProductWindow()">
                发布产品<br><span class="text-[10px] opacity-50">LAUNCH</span>
            </button>
        </div>
    </div>

    <div id="intel-window" class="side-window">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-blue-900/20">
            <h2 class="text-xl m-0 border-none p-0 text-[var(--intel-blue)]">全球情报中心</h2>
            <button class="text-gray-400 hover:text-white" onclick="toggleIntelWindow()">[X]</button>
        </div>
        <div class="tabs" id="intel-tabs"></div>
        <div class="flex-1 overflow-y-auto p-4 flex flex-col">
            <div class="mb-6">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-sm text-gray-400 font-bold">市场总规模 (TAM)</span>
                    <span class="text-xl text-white font-bold" id="market-size-display">$0 B</span>
                </div>
                <div class="market-bar-container rounded" id="market-share-bar"></div>
                <div class="flex justify-between text-xs text-gray-500 mt-1"><span>DOMINANCE</span><span>FRAGMENTATION</span></div>
            </div>
            <div class="mb-4 flex-1">
                <div class="text-xs text-[var(--intel-blue)] font-bold border-b border-gray-800 pb-1 mb-2">主要竞争实体</div>
                <div id="competitor-list" class="flex flex-col"></div>
            </div>
            <div id="product-detail-panel" class="bg-black/50 border border-gray-700 p-4 rounded min-h-[150px]">
                <div class="text-center text-gray-500 text-xs mt-4">请选择上方企业查看产品分析...</div>
            </div>
        </div>
    </div>

    <div id="product-window" class="side-window">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-green-900/20">
            <h2 class="text-xl text-white m-0 border-none p-0">产品设计中心</h2>
            <button class="text-gray-400 hover:text-white" onclick="toggleProductWindow()">[X]</button>
        </div>
        <div class="tabs" id="product-tabs"></div>
        <div class="p-6 overflow-y-auto flex-1 relative">
            <div id="product-locked-mask" class="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center" style="display: none;">
                <div class="text-red-500 text-xl font-bold mb-2">SECTOR LOCKED</div>
                <div class="text-gray-400 text-sm text-center max-w-xs">该产业链尚未建立研发机构。<br>请前往 [核心研发] 成立分部。</div>
            </div>
            <div class="mb-6">
                <label class="text-sm text-gray-400 block mb-2">产品代号 / CODENAME</label>
                <input type="text" id="product-name" placeholder="e.g. Neural-Link X1" value="Project Alpha">
            </div>
            <div class="mb-6">
                <label class="text-sm text-green-400 block mb-3 font-bold border-b border-gray-800 pb-1">技术规格 / SPECS</label>
                <div class="mb-4"><div class="flex justify-between text-xs mb-1"><span id="label-spec-1" class="text-white">--</span><span class="text-green-400"><span id="val-spec-1">20</span> / <span id="max-spec-1" class="text-gray-500">20</span></span></div><input type="range" min="1" max="100" value="20" oninput="updateProductStats()" id="slider-1"></div>
                <div class="mb-4"><div class="flex justify-between text-xs mb-1"><span id="label-spec-2" class="text-white">--</span><span class="text-green-400"><span id="val-spec-2">20</span> / <span id="max-spec-2" class="text-gray-500">20</span></span></div><input type="range" min="1" max="100" value="20" oninput="updateProductStats()" id="slider-2"></div>
                <div class="mb-4"><div class="flex justify-between text-xs mb-1"><span id="label-spec-3" class="text-white">--</span><span class="text-green-400"><span id="val-spec-3">20</span> / <span id="max-spec-3" class="text-gray-500">20</span></span></div><input type="range" min="1" max="100" value="20" oninput="updateProductStats()" id="slider-3"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mb-4">
                 <div class="bg-gray-900 p-2 rounded border border-gray-700">
                    <div class="text-xs text-gray-400">产品力 (Potential Cap)</div>
                    <div class="text-lg text-white font-bold" id="calc-power">0%</div>
                 </div>
                 <div class="bg-gray-900 p-2 rounded border border-gray-700">
                    <div class="text-xs text-gray-400">竞争力 (Actual Grab)</div>
                    <div class="text-lg font-bold" id="calc-score">0</div>
                 </div>
            </div>

            <div class="bg-black/50 p-4 border border-gray-700 rounded mb-4">
                <div class="flex justify-between items-center mb-2"><span class="text-xs text-gray-400">研发/生产成本 (Cost)</span><span class="text-sm text-red-400">$<span id="calc-cost">0</span></span></div>
                <div class="flex justify-between items-center mb-4"><span class="text-xs text-gray-400">建议售价 (Price)</span><div class="flex items-center"><span class="text-gray-500 text-xs mr-1">$</span><input type="number" id="product-price" class="w-20 p-1 text-right text-sm" value="1000" oninput="updateProfit()"></div></div>
                <div class="h-px bg-gray-700 mb-2"></div>
                <div class="flex justify-between items-center mb-2"><span class="text-xs text-white font-bold">利润率 (Margin)</span><span class="text-lg font-bold" id="calc-margin">0%</span></div>
            </div>
            <button id="launch-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-[0_0_10px_rgba(0,255,0,0.3)] transition-all" onclick="launchProduct()">确认发布 / LAUNCH</button>
        </div>
    </div>

    <div id="tech-window" class="side-window">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-green-900/20">
            <h2 class="text-xl text-white m-0 border-none p-0">核心研发实验室</h2>
            <button class="text-gray-400 hover:text-white" onclick="toggleTechWindow()">[X]</button>
        </div>
        <div class="tabs" id="tech-tabs"></div>
        <div class="p-6 overflow-y-auto flex-1 relative" id="tech-content"></div>
        <div id="tech-detail-panel" class="p-4 border-t border-gray-800 bg-black min-h-[120px] flex flex-col justify-center"><div class="text-center text-gray-500 text-xs">点击上方科技节点查看详细信息...</div></div>
    </div>

    <div id="market-window" class="side-window">
        <div class="p-4 border-b border-purple-800 flex justify-between items-center bg-purple-900/10 backdrop-blur-md">
            <h2 class="text-xl m-0 border-none p-0 text-[var(--market-purple)] tracking-widest font-bold">资本运作中心</h2>
            <button class="text-purple-400 hover:text-white transition-colors" onclick="toggleMarketWindow()">[X]</button>
        </div>
        <div class="p-4 overflow-y-auto flex-1 scrollbar-thin scrollbar-thumb-purple-900 scrollbar-track-black">
            <div class="mb-6 bg-black/40 p-3 rounded border border-purple-900/30">
                <div class="text-xs text-purple-300 mb-2 font-bold flex items-center gap-2">
                    <span class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></span>
                    市值走势 (VALUATION TREND)
                </div>
                <svg id="valuation-chart" viewBox="0 0 300 100"></svg>
            </div>

            <div class="mb-6">
                <div class="text-xs text-[var(--market-purple)] font-bold border-b border-purple-900/50 pb-1 mb-3 flex justify-between">
                    <span>全球市值排名 (GLOBAL RANK)</span>
                    <span class="opacity-50">LIVE</span>
                </div>
                <div id="market-cap-leaderboard" class="flex flex-col gap-1">
                    <!-- Leaderboard items will be injected here -->
                </div>
            </div>

            <div class="text-xs text-[var(--market-purple)] font-bold border-b border-purple-900/50 pb-1 mb-3">并购目标 (M&A TARGETS)</div>
            <div id="ma-list" class="space-y-3"></div>
        </div>
    </div>

    <div id="ops-window" class="side-window">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-red-900/20">
            <h2 class="text-xl m-0 border-none p-0 text-[var(--ops-red)] tracking-widest">秘密行动局</h2>
            <button class="text-gray-400 hover:text-white" onclick="toggleOpsWindow()">[X]</button>
        </div>
        <div class="p-4 overflow-y-auto flex-1">
            <div class="mb-4">
                <div class="text-xs text-gray-500 mb-2">操作终端 (OPS TERMINAL)</div>
                <div class="ops-console" id="ops-console">
                    <div class="console-line">> SYSTEM INITIALIZED...</div>
                    <div class="console-line">> WAITING FOR COMMAND...</div>
                </div>
            </div>
            <div class="text-xs text-[var(--ops-red)] font-bold border-b border-gray-800 pb-1 mb-3">可用手段 (AVAILABLE TACTICS)</div>
            <div id="ops-list" class="space-y-2"></div>
        </div>
    </div>

    <div id="placement-hint">
        <h2 class="text-white border-none mb-0 text-xl">建立<span id="hint-type">总部</span></h2>
        <p class="text-green-400 text-sm mt-2">请点击 <span id="hint-region-name" class="font-bold text-white">区域</span> 地图上的任意位置</p>
    </div>

    <div id="setup-overlay" class="overlay-panel">
        <div class="setup-panel">
            <div class="corner-deco tl"></div><div class="corner-deco tr"></div>
            <div class="corner-deco bl"></div><div class="corner-deco br"></div>
            <div class="setup-sidebar border-r border-gray-800 p-8 bg-green-900/5">
                <h2>初始化参数</h2>
                <div class="input-group mb-5">
                    <label class="block text-xs text-gray-500 mb-1">公司名称 / COMPANY NAME</label>
                    <input type="text" id="company-name-input" placeholder="例如: CyberDyne Systems" maxlength="15">
                </div>
                <div class="input-group">
                    <label class="block text-xs text-gray-500 mb-1">选择大区 / REGION</label>
                    <div id="region-list"></div>
                </div>
                <div class="mt-5 text-xs text-gray-400 border-t border-gray-800 pt-3"><div id="region-desc">请选择一个起始大区...</div></div>
            </div>
            <div class="setup-main p-8 overflow-y-auto">
                <h2>选择生态位 / ROLE</h2>
                <p class="text-xs text-gray-500 mb-4">这决定了你的起步技术栈。</p>
                <div class="chain-container flex flex-col gap-3">
                    <div class="chain-card" onclick="selectRole('level0', this)"><div class="text-lg font-bold text-white">TIER 0: 源头设备</div><div class="text-xs text-gray-500 mt-1">制造光刻机。技术门槛极高，垄断地位。</div><div class="text-[10px] text-green-500 mt-1">对手: ASML</div></div>
                    <div class="chain-card" onclick="selectRole('level1', this)"><div class="text-lg font-bold text-white">TIER 1: 晶圆代工</div><div class="text-xs text-gray-500 mt-1">超级工厂。资本密集，产能即正义。</div><div class="text-[10px] text-green-500 mt-1">对手: TSMC</div></div>
                    <div class="chain-card" onclick="selectRole('level2', this)"><div class="text-lg font-bold text-white">TIER 2: 核心架构</div><div class="text-xs text-gray-500 mt-1">设计芯片。高利润，研发竞争激烈。</div><div class="text-[10px] text-green-500 mt-1">对手: NVIDIA</div></div>
                    <div class="chain-card" onclick="selectRole('level3', this)"><div class="text-lg font-bold text-white">TIER 3: 终端平台</div><div class="text-xs text-gray-500 mt-1">面向消费者。现金流之王。</div><div class="text-[10px] text-green-500 mt-1">对手: Apple, Tesla</div></div>
                </div>
                <button id="start-btn" onclick="enterPlacementMode()">初始化并选址 / DEPLOY</button>
            </div>
        </div>
    </div>

    <div id="loading" class="absolute inset-0 flex items-center justify-center z-50 bg-black">
        <div class="text-xl tracking-[0.5em] text-[var(--primary-green)] animate-pulse">
            LOADING_GEO_DATA...
        </div>
    </div>

    <div id="tooltip"></div>
    <div id="map-container"></div>

    <script>
    // =================== 游戏数据结构 ===================
    const gameState = {
        player: { name: "", region: "", role: "", coords: null, cash: 999999.0, valuation: 0 }, 
        branches: [], // {role, coords, regionName}
        step: 'setup',
        currentTabRole: 'level0',
        techTabRole: 'level0',
        intelTabRole: 'level0',
        placingBranch: null,
        tech: {},
        selectedTechNode: null,
        selectedCompetitor: null, 
        marketData: {},
        products: {},
        date: { year: 2030, month: 1 },
        valuationHistory: { player: [], level0:[], level1:[], level2:[], level3:[] },
        newsLog: [] // 最新新闻列表
    };

    // 区域加成配置 (Bonus)
    const regionBonuses = {
        "North America": { costFactor: 1.0, rdFactor: 0.8, compBoost: 1.1, label: "硅谷红利: 研发费用-20%, 竞争力+10%" },
        "Asia": { costFactor: 0.8, rdFactor: 1.1, compBoost: 1.0, label: "制造中心: 生产成本-20%" },
        "Europe": { costFactor: 1.1, rdFactor: 0.9, compBoost: 1.05, label: "精密工程: 研发费用-10%, 竞争力+5%" },
        "South America": { costFactor: 0.9, rdFactor: 1.2, compBoost: 0.9, label: "新兴市场: 成本-10%, 研发+20%" },
        "Oceania": { costFactor: 1.2, rdFactor: 1.0, compBoost: 1.0, label: "孤立市场: 无特殊加成" },
        "Africa": { costFactor: 0.7, rdFactor: 1.5, compBoost: 0.8, label: "未开发地: 成本-30%, 研发+50%" },
        "Antarctica": { costFactor: 2.0, rdFactor: 2.0, compBoost: 0.5, label: "极地科研: 成本极高" }
    };

    // 产业链配置
    const tierConfig = {
        'level0': {
            name: "Tier 0: 核心设备", short: "设备/光刻", specs: ["加工精度", "产出效率", "系统稳定性"],
            initialMarket: 120,
            topComp: { name: "ASML", share: 85, flagship: "High-NA EUV", specs: [95, 90, 90], score: 98, acquired: false },
            avgComp: { name: "行业平均", flagship: "Standard Litho", specs: [40, 50, 60], score: 45 },
            unlockCost: 5000, baseCost: 500, defaultPrice: 2000,
            techTree: [
                {name:"光源系统",nodes:["DUV 透镜","浸没式","EUV 光学","High-NA"],costs:[0,2000,5000,10000],descs:["基础深紫外线光刻。","液体增强折射率。","极紫外线反射光学。","埃米级工艺入场券。"]},
                {name:"工件台",nodes:["步进电机","双工件台","磁悬浮","量子同步"],costs:[0,1500,4000,8000],descs:["基础步进式扫描。","双台并行处理。","纳米级精准控制。","消除机械误差。"]},
                {name:"环境控制",nodes:["洁净室","温控系统","真空腔体","零重力模拟"],costs:[0,1000,3000,6000],descs:["标准百级洁净。","0.001度温控。","减少EUV能量损耗。","消除重力微变形。"]}
            ],
            calcCost: (v1,v2,v3)=>500+Math.pow(v1,1.8)*0.5+v2*5+v3*3,
            up: null, down: 'level1'
        },
        'level1': {
            name: "Tier 1: 晶圆制造", short: "晶圆/制造", specs: ["晶体管密度", "制程良率", "生产周期"],
            initialMarket: 150,
            topComp: { name: "TSMC", share: 55, flagship: "N2 Process", specs: [92, 95, 85], score: 95, acquired: false },
            avgComp: { name: "行业平均", flagship: "Legacy Node", specs: [30, 80, 50], score: 50 },
            unlockCost: 10000, baseCost: 300, defaultPrice: 1000,
            techTree: [
                {name:"制程架构",nodes:["Planar","FinFET","GAAFET","3D Stacking"],costs:[0,3000,8000,15000],descs:["平面晶体管。","鳍式场效应。","全环绕栅极。","垂直堆叠。"]},
                {name:"检测系统",nodes:["人工镜检","AOI 光学","AI 缺陷识别","自愈合材料"],costs:[0,1500,4000,7000],descs:["显微抽检。","自动光学检测。","深度学习分析。","纳米材料修复。"]},
                {name:"流水线",nodes:["批次处理","连续流","数字孪生","原子级组装"],costs:[0,2000,5000,9000],descs:["批次流转。","优化节拍。","全虚拟模拟。","无缺陷制造。"]}
            ],
            calcCost: (v1,v2,v3)=>Math.max(100,300+Math.pow(v1,1.5)*0.8-(v2-50)*2+v3*2),
            up: 'level0', down: 'level2'
        },
        'level2': {
            name: "Tier 2: 芯片设计", short: "架构/芯片", specs: ["算力性能", "能效比", "通用性"],
            initialMarket: 500,
            topComp: { name: "NVIDIA", share: 80, flagship: "B200 Blackwell", specs: [98, 85, 90], score: 99, acquired: false },
            avgComp: { name: "行业平均", flagship: "Generic CPU", specs: [40, 50, 70], score: 55 },
            unlockCost: 8000, baseCost: 100, defaultPrice: 800,
            techTree: [
                {name:"计算核心",nodes:["FP32 Core","Tensor Core","Transformer","类脑架构"],costs:[0,2500,6000,12000],descs:["通用计算单元。","矩阵运算优化。","大模型优化。","模拟生物突触。"]},
                {name:"封装技术",nodes:["2D Layout","Chiplet","SoIC","光互连"],costs:[0,2000,5000,10000],descs:["平面封装。","小芯片异构。","系统级集成。","片间光通讯。"]},
                {name:"软件栈",nodes:["基础驱动","统一内存","Omniverse","AGI 协议"],costs:[0,1500,4000,8000],descs:["基础桥梁。","显存共享。","数字孪生底座。","通用AI接口。"]}
            ],
            calcCost: (v1,v2,v3)=>100+(v1*v2)/150+v3*4,
            up: 'level1', down: 'level3'
        },
        'level3': {
            name: "Tier 3: 终端平台", short: "终端/平台", specs: ["用户体验", "硬件耐久", "生态整合"],
            initialMarket: 3000,
            topComp: { name: "Apple", share: 25, flagship: "iPhone 17 Pro", specs: [90, 95, 95], score: 97, acquired: false },
            avgComp: { name: "行业平均", flagship: "Commodity Device", specs: [50, 50, 40], score: 50 },
            unlockCost: 6000, baseCost: 200, defaultPrice: 1200,
            techTree: [
                {name:"交互方式",nodes:["多点触控","视网膜屏","空间计算","脑机接口"],costs:[0,3000,7000,14000],descs:["手指操作。","超人眼精度。","手势/眼动。","脑机接口。"]},
                {name:"材料科学",nodes:["铝合金","钛金属","超瓷晶","液态金属"],costs:[0,1500,3000,6000],descs:["易加工。","航天级强度。","透明陶瓷。","非晶态合金。"]},
                {name:"生态系统",nodes:["应用商店","云同步","连续互通","蜂群思维"],costs:[0,2500,6000,11000],descs:["软件分发。","数据实时备份。","跨设备接力。","全球算力共享。"]}
            ],
            calcCost: (v1,v2,v3)=>200+v1*3+v2*2+Math.pow(v3,1.6)*0.4,
            up: 'level2', down: null
        }
    };

    const regionsData = {
        "North America": { diff: "Normal", label: "北美战区", class:"text-green-400", desc: "资本充裕，市场巨大。" },
        "Asia": { diff: "Hard", label: "泛亚细亚", class:"text-red-400", desc: "制造中心，地缘风险高。" },
        "Europe": { diff: "Medium", label: "欧罗巴", class:"text-yellow-400", desc: "科研扎实，法规严格。" },
        "South America": { diff: "Hard", label: "南美洲", class:"text-red-400", desc: "资源丰富，基建薄弱。" },
        "Oceania": { diff: "Hard", label: "大洋洲", class:"text-yellow-400", desc: "偏安一隅，隐蔽性强。" },
        "Africa": { diff: "Extreme", label: "非洲", class:"text-red-500", desc: "未经开发的处女地。" }
    };

    // 初始对手
    const techCompanies = [
        { name: "Apple", coords: [-122.03, 37.32], type: "Platform", id: "Apple", role: "level3" },
        { name: "NVIDIA", coords: [-121.95, 37.35], type: "Architect", id: "NVIDIA", role: "level2" },
        { name: "TSMC", coords: [120.96, 24.81], type: "Foundry", id: "TSMC", role: "level1" },
        { name: "ASML", coords: [5.40, 51.41], type: "Equipment", id: "ASML", role: "level0" }
    ];

    // 旧的 newsItems 不再用作循环播报，只保留文字素材
    const newsItems = ["台积电 2nm 良率提升", "北美算力需求激增", "海底光缆信号异常", "欧盟启动反垄断调查", "量子计算原型机测试"];

    // =================== 秘密行动数据 ===================
    const opsDatabase = [
        { 
            id: "sabotage", name: "工业破坏", type: "rival", cost: 2000, chance: 0.7,
            desc: "针对同级竞争对手。物理破坏生产线，压制其基础市场份额与竞争力。"
        },
        { 
            id: "poach", name: "高管猎头", type: "rival", cost: 5000, chance: 0.6,
            desc: "针对同级竞争对手。挖走核心研发团队，抬升我方目标份额与利润率。"
        },
        { 
            id: "cut_supply", name: "限制出口", type: "downstream", cost: 3000, chance: 0.8,
            desc: "针对下游客户。中断关键组件供应，压缩其基础份额与市场规模。"
        },
        { 
            id: "backdoor", name: "硬件后门", type: "downstream", cost: 8000, chance: 0.4,
            desc: "针对下游客户。在组件中植入逻辑后门，为未来的数据与利润率打基础。"
        },
        { 
            id: "cancel_order", name: "恶意砍单", type: "upstream", cost: 1000, chance: 0.9,
            desc: "针对上游供应商。突然取消巨额订单，打击其TAM，同时改善我方议价能力。"
        },
        { 
            id: "patent_troll", name: "专利流氓", type: "upstream", cost: 4000, chance: 0.5,
            desc: "针对上游供应商。利用老专利发起诉讼，拖累其新技术部署与基础份额。"
        }
    ];

    // =================== 新闻系统：统一入口 ===================
    function pushNews(message) {
        if (!gameState.newsLog) gameState.newsLog = [];
        gameState.newsLog.unshift(message);
        if (gameState.newsLog.length > 8) gameState.newsLog.pop();
        
        const newsContent = document.getElementById('news-content');
        if (newsContent) {
            // Reset animation safely to prevent jumping
            newsContent.classList.remove('scrolling');
            // Force reflow
            void newsContent.offsetWidth;
            newsContent.innerHTML = gameState.newsLog.join(" &nbsp;///&nbsp; ");
            newsContent.classList.add('scrolling');
        }
    }

    // =================== 随机世界事件 ===================
    function worldEventAiBoom() {
        const role = 'level2';
        const data = gameState.marketData[role];
        if (!data) return null;
        data.marketSize *= 1.1;
        return `全球 AI 投资热潮：${tierConfig[role].name} 市场总规模瞬间放大 10%。`;
    }

    function worldEventRecession() {
        const roles = ['level0','level1','level2','level3'];
        const role = roles[Math.floor(Math.random()*roles.length)];
        const data = gameState.marketData[role];
        if (!data) return null;
        data.marketSize *= 0.93;
        return `宏观经济放缓：${tierConfig[role].name} 需求萎缩约 7%。`;
    }

    function worldEventPlayerBreakthrough() {
        const roles = Object.keys(gameState.tech).filter(r => gameState.tech[r].unlocked);
        if (roles.length === 0) return null;
        const role = roles[Math.floor(Math.random()*roles.length)];
        const data = gameState.marketData[role];
        if (!data) return null;
        if (!data.targets) data.targets = { player: data.shares.player || 0 };
        const gain = 5;
        data.targets.player = Math.min(95, (data.targets.player || data.shares.player) + gain);
        data.margin = Math.min(0.9, (data.margin || 0) + 0.03);
        return `技术突破：${gameState.player.name} 在 ${tierConfig[role].name} 获得关键进展，目标份额 +${gain}pt，利润率提升。`;
    }

    function worldEventCompetitorScandal() {
        const roles = ['level0','level1','level2','level3'].filter(r => !tierConfig[r].topComp.acquired);
        if (roles.length === 0) return null;
        const role = roles[Math.floor(Math.random()*roles.length)];
        const conf = tierConfig[role];
        const comp = conf.topComp;
        const beforeShare = comp.share;
        comp.share = Math.max(5, comp.share - 4);
        const delta = beforeShare - comp.share;
        const beforeScore = comp.score;
        comp.score = Math.max(20, comp.score - 6);
        return `安全/财务丑闻：${comp.name} 在 ${conf.name} 的基础份额 -${delta.toFixed(1)}pt，竞争力从 ${beforeScore} 下滑至 ${comp.score}。`;
    }

    function worldEventRegulationPlayer() {
        const roles = Object.keys(gameState.tech).filter(r => gameState.tech[r].unlocked);
        if (roles.length === 0) return null;
        const role = roles[Math.floor(Math.random()*roles.length)];
        const data = gameState.marketData[role];
        if (!data) return null;
        if (!data.targets) data.targets = { player: data.shares.player || 0 };
        const loss = 4;
        data.targets.player = Math.max(0, (data.targets.player || data.shares.player) - loss);
        data.margin = Math.max(0, (data.margin || 0) - 0.03);
        return `监管施压：${gameState.player.name} 在 ${tierConfig[role].name} 遭遇反垄断调查，目标份额 -${loss}pt，利润率受压。`;
    }

    function worldEventSupplyShock() {
        const role = 'level1';
        const data = gameState.marketData[role];
        if (!data) return null;
        data.marketSize *= 0.97;
        const beforeShare = tierConfig[role].topComp.share;
        tierConfig[role].topComp.share = Math.max(5, tierConfig[role].topComp.share - 2);
        const delta = beforeShare - tierConfig[role].topComp.share;
        return `供应链冲击：全球晶圆产线局部停工，${tierConfig[role].name} TAM 收缩 3%，龙头基础份额 -${delta.toFixed(1)}pt。`;
    }

    const worldEventPool = [
        worldEventAiBoom,
        worldEventRecession,
        worldEventPlayerBreakthrough,
        worldEventCompetitorScandal,
        worldEventRegulationPlayer,
        worldEventSupplyShock
    ];

    function triggerWorldEvent() {
        if (gameState.step !== 'playing') return;
        if (!gameState.marketData.level0) return;
        const fn = worldEventPool[Math.floor(Math.random()*worldEventPool.length)];
        const msg = fn();
        if (msg) pushNews(msg);
    }

    // =================== 游戏循环 & 经济 ===================
    function startGame(coords) {
        gameState.step = 'playing';
        gameState.player.coords = coords;
        const rName = gameState.player.region;
        gameState.branches.push({ role: gameState.player.role, coords: coords, regionName: rName });

        document.getElementById('placement-hint').style.display = 'none';
        document.body.classList.remove('placement-mode');
        
        drawMapObjects();
        document.querySelector('.game-ui').classList.add('active');
        
        document.getElementById('hud-company-name').innerText = gameState.player.name.toUpperCase();
        document.getElementById('hud-sector').innerText = tierConfig[gameState.player.role].short;
        document.getElementById('hud-region').innerText = rName.toUpperCase();
        updateCashDisplay();

        gameState.newsLog = [];
        pushNews("系统上线：全球市场情报链路已接通。");
        
        // Initial kick to start animation
        const newsEl = document.getElementById('news-content');
        if(newsEl) newsEl.classList.add('scrolling');

        ['level0', 'level1', 'level2', 'level3'].forEach(role => {
            const topComp = tierConfig[role].topComp;
            gameState.marketData[role] = {
                marketSize: tierConfig[role].initialMarket,
                shares: { player: 0, top: topComp.share, avg: 100 - topComp.share },
                targets: { player: 0 },
                margin: 0 
            };
        });

        generateTabs(); 
        updateMapStyles();

        setInterval(gameTick, 1000);
    }

    function gameTick() {
        if (gameState.step !== 'playing') return;

        gameState.date.month++;
        if (gameState.date.month > 12) { gameState.date.month = 1; gameState.date.year++; }
        document.getElementById('date-display').innerText = `${gameState.date.year}-${String(gameState.date.month).padStart(2,'0')}`;

        let totalProfit = 0;
        gameState.player.valuation = 0;

        ['level0', 'level1', 'level2', 'level3'].forEach(role => {
            const data = gameState.marketData[role];
            const config = tierConfig[role];
            if (!data) return;

            data.marketSize *= 1.002;
            if (!Number.isFinite(data.marketSize) || data.marketSize < 1) data.marketSize = 1;

            if (!Number.isFinite(data.margin)) data.margin = 0;
            data.margin = Math.max(-0.5, Math.min(0.95, data.margin));

            const target = (data.targets && typeof data.targets.player === 'number') ? data.targets.player : 0;
            data.shares.player += (target - data.shares.player) * 0.05;

            if (data.shares.player < 0) data.shares.player = 0;
            if (data.shares.player > 100) data.shares.player = 100;

            let remaining = 100 - data.shares.player;
            if (remaining < 0) remaining = 0;
            
            if (config.topComp.acquired) {
                data.shares.top = 0;
                data.shares.avg = remaining;
            } else {
                const initialTop = config.topComp.share;
                const initialAvg = 100 - initialTop;
                const ratio = (initialTop + initialAvg) > 0 ? initialTop / (initialTop + initialAvg) : 0.5;
                
                data.shares.top = remaining * ratio;
                data.shares.avg = remaining * (1 - ratio);
            }

            const revenue = data.marketSize * (data.shares.player / 100);
            const profit = revenue * data.margin;
            if (Number.isFinite(profit)) {
                totalProfit += profit;
            }

            const baseTopVal = data.marketSize * (data.shares.top / 100) * 5;
            const noiseTop = 1 + (Math.random() - 0.5) * 0.06; 
            gameState.valuationHistory[role].push(baseTopVal * noiseTop);

            gameState.player.valuation += revenue * 5;
        });

        if (!Number.isFinite(totalProfit)) totalProfit = 0;

        const playerNoise = 1 + (Math.random() - 0.5) * 0.06; 
        gameState.player.valuation *= playerNoise;
        if (!Number.isFinite(gameState.player.valuation) || gameState.player.valuation < 0) {
            gameState.player.valuation = 0;
        }
        gameState.valuationHistory.player.push(gameState.player.valuation);

        for (let key in gameState.valuationHistory) {
            if (gameState.valuationHistory[key].length > 20) gameState.valuationHistory[key].shift();
        }

        gameState.player.cash += totalProfit;
        if (!Number.isFinite(gameState.player.cash) || gameState.player.cash < 0) {
            gameState.player.cash = 0;
        }
        // 简单上限，防止数字过大溢出显示
        if (gameState.player.cash > 999999999) {
            gameState.player.cash = 999999999;
        }
        updateCashDisplay(totalProfit);

        // 随机世界事件（概率调低，约20秒一次）
        if (Math.random() < 0.05) {
            triggerWorldEvent();
        }

        if (document.getElementById('intel-window').classList.contains('open')) renderIntelContent(gameState.intelTabRole);
        if (document.getElementById('market-window').classList.contains('open')) renderMarketContent();
    }

    function getRegionBonus(role) {
        const branch = gameState.branches.find(b => b.role === role);
        if (!branch) return { costFactor: 1, rdFactor: 1, compBoost: 1 };
        return regionBonuses[branch.regionName] || { costFactor: 1, rdFactor: 1, compBoost: 1 };
    }

    function updateCashDisplay(profitPerSec) {
        if (!Number.isFinite(gameState.player.cash) || gameState.player.cash < 0) {
            gameState.player.cash = 0;
        }
        document.getElementById('cash-display').innerText = Math.floor(gameState.player.cash).toLocaleString();
        
        if (profitPerSec !== undefined) {
            const el = document.getElementById('profit-display');
            const val = profitPerSec.toFixed(1);
            if (profitPerSec >= 0) {
                el.innerText = `+${val} B / month`;
                el.className = "text-[10px] text-green-500";
            } else {
                el.innerText = `${val} B / month`;
                el.className = "text-[10px] text-red-500";
            }
        }
    }

    function spendCash(amount) {
        if (gameState.player.cash >= amount) {
            gameState.player.cash -= amount;
            if (gameState.player.cash < 0) gameState.player.cash = 0;
            updateCashDisplay(); 
            return true;
        }
        const display = document.getElementById('cash-display').parentElement;
        display.style.border = "1px solid red";
        setTimeout(() => display.style.border = "1px solid rgba(34, 197, 94, 0.3)", 200);
        return false;
    }

    function launchProduct() {
        const role = gameState.currentTabRole;
        const name = document.getElementById('product-name').value;
        const score = parseInt(document.getElementById('calc-score').innerText);
        const productPower = parseInt(document.getElementById('calc-power').innerText); 
        const specs = [1,2,3].map(i => parseInt(document.getElementById(`slider-${i}`).value));
        const marginPercent = parseInt(document.getElementById('calc-margin').innerText);

        gameState.products[role] = { name, specs, score };
        
        const cap = productPower; 
        const efficiency = score / 100; 
        const targetShare = cap * efficiency;
        
        if (gameState.marketData[role] && gameState.marketData[role].targets) {
            gameState.marketData[role].targets.player = Math.min(95, Math.max(0, targetShare));
        }
        gameState.marketData[role].margin = marginPercent / 100;

        const btn = document.getElementById('launch-btn');
        const originalText = btn.innerText;
        btn.innerText = "发布成功 / RELEASED!";
        btn.classList.add('bg-white', 'text-black');
        
        setTimeout(() => {
            btn.innerText = originalText;
            btn.classList.remove('bg-white', 'text-black');
            toggleProductWindow();
            pushNews(`<span class="text-white font-bold">新品发布: ${gameState.player.name} 推出了 ${name}! 目标份额: ${targetShare.toFixed(1)}%</span>`);
        }, 1000);
    }

    function toggleMarketWindow() {
        const win = document.getElementById('market-window');
        const isOpen = win.classList.contains('open');
        closeAllWindows();
        if (!isOpen) { 
            win.classList.add('open');
            renderMarketContent();
        }
    }

    function renderMarketContent() {
        const svg = document.getElementById('valuation-chart');
        svg.innerHTML = ""; 
        const history = gameState.valuationHistory;
        const len = history.player.length;
        if (len < 2) return;

        let maxVal = 100;
        for (let k in history) {
            if (history[k].length > 0) {
                maxVal = Math.max(maxVal, ...history[k]);
            }
        }
        
        const w = 300, h = 100;
        const dx = w / (len - 1);
        const colors = { player: '#00ff9d', level0: '#ef4444', level1: '#ef4444', level2: '#ef4444', level3: '#ef4444' };
        
        for (let k in history) {
            if (history[k].length === 0) continue;
            let points = "";
            history[k].forEach((val, i) => {
                const x = i * dx;
                const y = h - (val / maxVal * h);
                points += `${x},${y} `;
            });
            const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            polyline.setAttribute("points", points);
            polyline.setAttribute("fill", "none");
            polyline.setAttribute("stroke", colors[k]);
            polyline.setAttribute("stroke-width", k==='player'?2:1);
            if (k !== 'player') polyline.setAttribute("opacity", "0.5");
            svg.appendChild(polyline);
        }

        // === Render Leaderboard ===
        const leaderList = document.getElementById('market-cap-leaderboard');
        let companies = [];

        // 1. Player
        companies.push({
            name: gameState.player.name,
            val: gameState.player.valuation,
            isPlayer: true,
            role: 'ALL'
        });

        // 2. Competitors
        ['level0', 'level1', 'level2', 'level3'].forEach(role => {
            const conf = tierConfig[role];
            const data = gameState.marketData[role];
            if (conf.topComp.acquired) return;

            // Calculate Valuation: marketSize * (share/100) * 10
            const val = data.marketSize * (conf.topComp.share / 100) * 10;
            companies.push({
                name: conf.topComp.name,
                val: val,
                isPlayer: false,
                role: conf.short
            });
        });

        // Sort descending
        companies.sort((a,b) => b.val - a.val);

        let lbHtml = "";
        companies.forEach((c, idx) => {
            const rank = idx + 1;
            const colorClass = c.isPlayer ? "text-green-400 bg-green-900/30 border-l-2 border-green-500" : "text-gray-300";
            const valStr = Math.floor(c.val).toLocaleString();
            const rankClass = rank === 1 ? "top-1" : (rank === 2 ? "top-2" : (rank === 3 ? "top-3" : ""));
            
            lbHtml += `
            <div class="market-ranking-row ${c.isPlayer ? 'bg-green-900/20' : ''}">
                <div class="rank-num ${rankClass}">#${rank}</div>
                <div class="flex-1">
                    <div class="text-sm font-bold ${c.isPlayer ? 'text-green-400' : 'text-white'}">${c.name}</div>
                    <div class="text-xs text-gray-500">${c.role}</div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-mono text-market-purple font-bold">$${valStr} B</div>
                </div>
            </div>`;
        });
        leaderList.innerHTML = lbHtml;

        // === Render M&A Targets ===
        const list = document.getElementById('ma-list');
        let html = "";
        ['level0', 'level1', 'level2', 'level3'].forEach(role => {
            const comp = tierConfig[role].topComp;
            if (comp.acquired) return; 

            const valuation = gameState.marketData[role].marketSize * (comp.share / 100) * 10;
            const cost = Math.floor(valuation);

            html += `
            <div class="bg-purple-900/10 border border-purple-500/30 p-3 rounded flex justify-between items-center hover:bg-purple-900/20 transition-colors">
                <div>
                    <div class="text-sm font-bold text-white">${comp.name}</div>
                    <div class="text-xs text-gray-400">行业: ${tierConfig[role].short}</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-[var(--market-purple)] mb-1 font-mono">$${cost} B</div>
                    <button class="bg-purple-700 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded shadow-lg" onclick="acquireCompany('${role}', ${cost})">收购</button>
                </div>
            </div>`;
        });
        
        if (html === "") html = "<div class='text-gray-500 text-center text-xs py-4'>暂无更多并购目标</div>";
        list.innerHTML = html;
    }

    function acquireCompany(role, cost) {
        if (!spendCash(cost)) return;

        const config = tierConfig[role];
        config.topComp.acquired = true; 
        
        gameState.tech[role].unlocked = true;
        gameState.tech[role].specs.forEach(s => s.level = 2);

        gameState.products[role] = {
            name: config.topComp.flagship + " (Acquired)",
            specs: config.topComp.specs,
            score: config.topComp.score
        };
        
        const data = gameState.marketData[role];
        if (data) {
            const newShare = Math.min(95, data.shares.player + config.topComp.share); 
            data.shares.player = newShare;
            data.shares.top = 0;
            data.shares.avg = Math.max(0, 100 - newShare);
            if (!data.targets) data.targets = { player: 0 };
            data.targets.player = newShare;           
            data.margin = Math.max(data.margin, 0.3); 
        }

        const techCompIdx = techCompanies.findIndex(c => c.role === role);
        if (techCompIdx !== -1) {
            const comp = techCompanies[techCompIdx];
            gameState.branches.push({ role: role, coords: comp.coords, regionName: "Global" }); 
        }

        toggleMarketWindow();
        drawMapObjects();
        pushNews(`<span class="text-[var(--market-purple)] font-bold">重磅收购: ${gameState.player.name} 完成了对 ${config.topComp.name} 的全资收购!</span>`);
    }

    function closeAllWindows() {
        document.querySelectorAll('.side-window').forEach(w => w.classList.remove('open'));
    }
    function toggleProductWindow() {
        const win = document.getElementById('product-window'); const isOpen = win.classList.contains('open'); closeAllWindows(); if (!isOpen) { switchProductTab(gameState.player.role); win.classList.add('open'); }
    }
    function toggleTechWindow() {
        const win = document.getElementById('tech-window'); const isOpen = win.classList.contains('open'); closeAllWindows(); if (!isOpen) { switchTechTab(gameState.player.role); win.classList.add('open'); document.getElementById('tech-detail-panel').innerHTML = '<div class="text-center text-gray-500 text-xs">点击上方科技节点查看详细信息...</div>'; }
    }
    function toggleIntelWindow() {
        const win = document.getElementById('intel-window'); const isOpen = win.classList.contains('open'); closeAllWindows(); if (!isOpen) { switchIntelTab(gameState.player.role); win.classList.add('open'); }
    }

    // =================== 秘密行动逻辑 ===================
    function toggleOpsWindow() {
        const win = document.getElementById('ops-window');
        const isOpen = win.classList.contains('open');
        closeAllWindows();
        if (!isOpen) {
            renderOpsList();
            win.classList.add('open');
        }
    }

    function logOps(msg, status) {
        const consoleDiv = document.getElementById('ops-console');
        const line = document.createElement('div');
        line.className = `console-line ${status === 'success' ? 'success' : (status === 'fail' ? 'fail' : '')}`;
        line.innerText = `> ${msg}`;
        consoleDiv.appendChild(line);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    function renderOpsList() {
        const list = document.getElementById('ops-list');
        let html = "";
        
        const myRoles = Object.keys(gameState.tech).filter(r => gameState.tech[r].unlocked);
        
        if (myRoles.length === 0) {
            list.innerHTML = `<div class="text-center text-gray-500 mt-10">暂无行动能力...</div>`;
            return;
        }

        opsDatabase.forEach(op => {
            myRoles.forEach(myRole => {
                let targetRole = null;
                let badge = "";
                let badgeClass = "";

                if (op.type === 'rival') {
                    targetRole = myRole;
                    badge = "RIVAL (同级)";
                    badgeClass = "badge-rival";
                } else if (op.type === 'upstream') {
                    targetRole = tierConfig[myRole].up;
                    badge = "UPSTREAM (上游)";
                    badgeClass = "badge-upstream";
                } else if (op.type === 'downstream') {
                    targetRole = tierConfig[myRole].down;
                    badge = "DOWNSTREAM (下游)";
                    badgeClass = "badge-downstream";
                }

                if (targetRole && !tierConfig[targetRole].topComp.acquired) {
                    const targetName = tierConfig[targetRole].topComp.name;
                    html += `
                    <div class="op-card" onclick="executeOp('${op.id}', '${targetRole}')">
                        <div class="flex justify-between items-start mb-1">
                            <div class="text-sm font-bold text-white">${op.name}</div>
                            <div class="text-xs text-[var(--ops-red)] border border-[var(--ops-red)] px-1">COST: $${op.cost}</div>
                        </div>
                        <div class="mb-2">
                            <span class="op-badge ${badgeClass}">${badge}</span>
                            <span class="text-xs text-gray-400">Target: <span class="text-white font-bold">${targetName}</span></span>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">${op.desc}</div>
                        <div class="text-[11px] text-gray-600 flex justify-between">
                            <span>SUCCESS RATE: ${Math.floor(op.chance * 100)}%</span>
                            <span class="text-[var(--ops-red)]">>> EXECUTE</span>
                        </div>
                    </div>`;
                }
            });
        });

        if (html === "") html = `<div class="text-center text-gray-500 text-xs mt-4">当前无可用目标 (可能已全部垄断)。</div>`;
        list.innerHTML = html;
    }

    function findMyRoleForTarget(opType, targetRole) {
        const myRoles = Object.keys(gameState.tech).filter(r => gameState.tech[r].unlocked);
        for (const myRole of myRoles) {
            if (opType === 'rival' && myRole === targetRole) return myRole;
            if (opType === 'upstream' && tierConfig[myRole].up === targetRole) return myRole;
            if (opType === 'downstream' && tierConfig[myRole].down === targetRole) return myRole;
        }
        return null;
    }

    function applyOpEffect(op, targetRole, myRole) {
        const config = tierConfig[targetRole];
        const data = gameState.marketData[targetRole];
        if (!config || !data) {
            return "目标市场结构不完整，行动效果有限。";
        }
        if (!data.targets) data.targets = { player: data.shares.player || 0 };

        let msg = "";

        switch (op.id) {
            case 'sabotage': {
                const beforeShare = config.topComp.share;
                config.topComp.share = Math.max(5, config.topComp.share - 5);
                const delta = beforeShare - config.topComp.share;
                const beforeScore = config.topComp.score;
                config.topComp.score = Math.max(30, config.topComp.score - 5);
                const gainTarget = delta > 0 ? delta * 0.6 : 0;
                data.targets.player = Math.min(95, (data.targets.player || data.shares.player) + gainTarget);
                msg = `${config.topComp.name} 工厂事故曝光，基础份额 -${delta.toFixed(1)}pt，竞争力 ${beforeScore}→${config.topComp.score}，预计有 ${gainTarget.toFixed(1)}pt 份额向你转移。`;
                break;
            }
            case 'poach': {
                const addShare = 6;
                data.targets.player = Math.min(95, (data.targets.player || data.shares.player) + addShare);
                data.margin = Math.min(0.85, (data.margin || 0) + 0.03);
                msg = `成功从 ${config.topComp.name} 挖走关键团队，你在 ${config.name} 的目标份额 +${addShare}pt，利润率小幅提升。`;
                break;
            }
            case 'cut_supply': {
                const beforeMs = data.marketSize;
                data.marketSize *= 0.95;
                const beforeShare2 = config.topComp.share;
                config.topComp.share = Math.max(5, config.topComp.share - 3);
                const delta2 = beforeShare2 - config.topComp.share;
                msg = `你限制上游供货，${config.topComp.name} 在 ${config.name} 的基础份额 -${delta2.toFixed(1)}pt，TAM 从 ${beforeMs.toFixed(1)}B 收缩至 ${data.marketSize.toFixed(1)}B。`;
                break;
            }
            case 'backdoor': {
                if (gameState.tech[targetRole] && gameState.tech[targetRole].unlocked) {
                    const add2 = 4;
                    data.targets.player = Math.min(95, (data.targets.player || data.shares.player) + add2);
                    data.margin = Math.min(0.9, (data.margin || 0) + 0.02);
                    msg = `成功在 ${config.topComp.name} 供应链中植入后门，你在 ${config.name} 的目标份额 +${add2}pt，并获取额外利润空间。`;
                } else {
                    msg = `后门模块已植入 ${config.topComp.name} 供应链，等待未来进入 ${config.name} 市场时激活。`;
                }
                break;
            }
            case 'cancel_order': {
                const beforeMs2 = data.marketSize;
                data.marketSize *= 0.97;
                const beforeShare3 = config.topComp.share;
                config.topComp.share = Math.max(5, config.topComp.share - 2);
                const delta3 = beforeShare3 - config.topComp.share;
                if (myRole && gameState.marketData[myRole]) {
                    const myData = gameState.marketData[myRole];
                    myData.margin = Math.min(0.85, (myData.margin || 0) + 0.02);
                }
                msg = `你对 ${config.topComp.name} 发起恶意砍单，上游 ${config.name} TAM 从 ${beforeMs2.toFixed(1)}B 降至 ${data.marketSize.toFixed(1)}B，基础份额 -${delta3.toFixed(1)}pt。`;
                break;
            }
            case 'patent_troll': {
                const beforeShare4 = config.topComp.share;
                const beforeScore2 = config.topComp.score;
                config.topComp.share = Math.max(5, config.topComp.share - 4);
                config.topComp.score = Math.max(20, config.topComp.score - 8);
                const delta4 = beforeShare4 - config.topComp.share;
                msg = `专利诉讼缠身：${config.topComp.name} 在 ${config.name} 的基础份额 -${delta4.toFixed(1)}pt，竞争力 ${beforeScore2}→${config.topComp.score}。`;
                break;
            }
            default:
                msg = "行动执行完毕。";
        }

        return msg;
    }

    function executeOp(opId, targetRole) {
        const op = opsDatabase.find(o => o.id === opId);
        if (!op) return;

        if (!spendCash(op.cost)) {
            logOps("资金不足，行动中止。", "fail");
            return;
        }

        const myRole = findMyRoleForTarget(op.type, targetRole);
        logOps(`正在执行: ${op.name} -> ${tierConfig[targetRole].topComp.name}...`);

        setTimeout(() => {
            const roll = Math.random();
            if (roll <= op.chance) {
                const resultMsg = applyOpEffect(op, targetRole, myRole);
                logOps(`任务成功! ${resultMsg}`, "success");

                if (document.getElementById('intel-window').classList.contains('open')) renderIntelContent(targetRole);
                
                pushNews(`<span class="text-red-500 font-bold">突发新闻: ${tierConfig[targetRole].topComp.name} 遭遇不明攻击!</span>`);

            } else {
                logOps("任务失败! 行动组被迫撤离。", "fail");
            }
        }, 800);
    }

    function switchIntelTab(role) {
        gameState.intelTabRole = role;
        if (gameState.selectedCompetitor && gameState.selectedCompetitor.role !== role) {
            gameState.selectedCompetitor = null;
        }
        document.querySelectorAll('#intel-tabs .tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('itab-' + role).classList.add('active');
        renderIntelContent(role);
    }

    function renderIntelContent(role) {
        const config = tierConfig[role];
        const isUnlocked = gameState.tech[role].unlocked;
        const mData = gameState.marketData[role];
        
        document.getElementById('market-size-display').innerText = "$" + Math.floor(mData.marketSize) + " B";
        
        const playerShare = mData.shares.player;
        const topShare = mData.shares.top;
        const otherShare = mData.shares.avg; 
        
        const barContainer = document.getElementById('market-share-bar');
        barContainer.innerHTML = `
            ${config.topComp.acquired ? '' : `<div class="market-bar-segment" style="width:${topShare}%; background:#ef4444; color:white;">${config.topComp.name} ${topShare.toFixed(1)}%</div>`}
            ${playerShare > 0.1 ? `<div class="market-bar-segment" style="width:${playerShare}%; background:var(--primary-green); color:black;">YOU ${playerShare.toFixed(1)}%</div>` : ''}
            <div class="market-bar-segment" style="width:${otherShare}%; background:#333; color:#888;">OTHERS</div>
        `;
        
        const list = document.getElementById('competitor-list');
        let html = "";
        if (!config.topComp.acquired) {
            html += `<div class="company-item" onclick="showCompetitorDetail('${role}', 'top')"><div class="flex justify-between items-center"><span class="text-sm font-bold text-white">${config.topComp.name}</span><span class="text-xs text-red-500">TOP 1</span></div></div>`;
        }
        if (isUnlocked) {
            html += `<div class="company-item" onclick="showCompetitorDetail('${role}', 'player')"><div class="flex justify-between items-center"><span class="text-sm font-bold text-[var(--primary-green)]">${gameState.player.name}</span><span class="text-xs text-[var(--primary-green)]">YOU</span></div></div>`;
        }
        html += `<div class="company-item" onclick="showCompetitorDetail('${role}', 'avg')"><div class="flex justify之间 items-center"><span class="text-sm font-bold text-gray-400">行业平均</span></div></div>`;
        
        list.innerHTML = html;

        if (gameState.selectedCompetitor && gameState.selectedCompetitor.role === role) {
            showCompetitorDetail(role, gameState.selectedCompetitor.type);
        }
    }

    function showCompetitorDetail(role, type) {
        gameState.selectedCompetitor = { role, type }; 
        
        const config = tierConfig[role];
        const panel = document.getElementById('product-detail-panel');
        let data, colorClass;
        
        if (type === 'top') { data = config.topComp; colorClass = "text-red-500"; } 
        else if (type === 'avg') { data = config.avgComp; colorClass = "text-gray-400"; } 
        else if (type === 'player') {
            const product = gameState.products[role];
            if (!product) { panel.innerHTML = `<div class="text-center text-gray-500 text-xs mt-4">尚未发布产品。</div>`; return; }
            data = { name: gameState.player.name, flagship: product.name, specs: product.specs, score: product.score };
            colorClass = "text-[var(--primary-green)]";
        }

        const labels = config.specs;
        let barsHtml = "";
        data.specs.forEach((val, idx) => {
            barsHtml += `<div class="spec-comparison-row"><div class="spec-label">${labels[idx]}</div><div class="spec-bar-bg"><div class="spec-bar-fill" style="width: ${val}%; background-color: ${type==='player'?'#00ff9d':(type==='top'?'#ef4444':'#888')}"></div></div><div class="spec-val">${val}</div></div>`;
        });
        panel.innerHTML = `<div class="flex justify-between items-start mb-3 border-b border-gray-700 pb-2"><div><div class="text-xs text-gray-500">旗舰产品</div><div class="text-lg font-bold text白">${data.flagship}</div></div><div class="text-right"><div class="text-xs text-gray-500">竞争力</div><div class="text-xl font-bold ${colorClass}">${data.score}</div></div></div><div class="space-y-1">${barsHtml}</div>`;
    }

    function updateProductStats() {
        const role = gameState.currentTabRole;
        const config = tierConfig[role];
        const bonus = getRegionBonus(role);
        
        const vals = [1, 2, 3].map(i => {
            const slider = document.getElementById(`slider-${i}`);
            let v = parseInt(slider.value);
            const limit = parseInt(slider.dataset.maxLimit || 20);
            if (v > limit) { v = limit; slider.value = limit; }
            document.getElementById(`val-spec-${i}`).innerText = v;
            return v;
        });

        let cost = config.calcCost(vals[0], vals[1], vals[2]);
        cost *= bonus.costFactor; 
        
        document.getElementById('calc-cost').innerText = Math.floor(cost);
        updateProfit(vals); 
    }

    function updateProfit(vals) {
        if (!vals) vals = [1,2,3].map(i => parseInt(document.getElementById(`slider-${i}`).value));
        const role = gameState.currentTabRole;
        const bonus = getRegionBonus(role);
        
        const rawCost = parseInt(document.getElementById('calc-cost').innerText);
        const cost = isNaN(rawCost) ? 0 : rawCost;
        const priceInput = parseInt(document.getElementById('product-price').value);
        const price = Math.max(1, isNaN(priceInput) ? 0 : priceInput); 
        
        const margin = price - cost;
        const marginPercent = price > 0 ? Math.round((margin / price) * 100) : 0;
        const el = document.getElementById('calc-margin');
        el.innerText = marginPercent + "%";
        el.className = "text-lg font-bold " + (marginPercent < 0 ? "text-red-500" : "text-green-400");

        const totalSpec = vals.reduce((a,b)=>a+b, 0);
        const maxPossibleSpec = 300; 
        const powerPercent = Math.min(100, Math.round((totalSpec / maxPossibleSpec) * 100));
        
        let score;
        if (price > 0) {
            let valueRatio = (totalSpec * 6) / price;
            if (price < cost) valueRatio *= 0.9; 

            const baseScore = 10;                  
            score = baseScore + valueRatio * 100; 
            score = score * bonus.compBoost;        

            score = Math.max(5, Math.min(100, Math.round(score)));
        } else {
            score = 5;
        }

        document.getElementById('calc-power').innerText = powerPercent + "%";
        document.getElementById('calc-score').innerText = score;
    }

    function initTechData(startRole) {
        const roles = ['level0', 'level1', 'level2', 'level3'];
        roles.forEach(role => { gameState.tech[role] = { unlocked: (role === startRole), specs: [0, 1, 2].map(i => ({ level: 0 })) }; });
    }
    const regionList = document.getElementById('region-list');
    for (const [key, data] of Object.entries(regionsData)) {
        const btn = document.createElement('button');
        btn.className = 'region-select-btn';
        btn.innerHTML = `${data.label} <span class="float-right text-[10px] ${data.class}">[${data.diff}]</span>`;
        btn.onclick = () => { gameState.player.region = key; document.querySelectorAll('.region-select-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); document.getElementById('region-desc').innerText = data.desc; checkReady(); };
        regionList.appendChild(btn);
    }
    function selectRole(roleKey, card) { gameState.player.role = roleKey; document.querySelectorAll('.chain-card').forEach(c => c.classList.remove('selected')); card.classList.add('selected'); checkReady(); }
    function checkReady() { if (document.getElementById('company-name-input').value && gameState.player.region && gameState.player.role) document.getElementById('start-btn').classList.add('ready'); else document.getElementById('start-btn').classList.remove('ready'); }
    document.getElementById('company-name-input').addEventListener('input', (e) => { gameState.player.name = e.target.value; checkReady(); });
    function enterPlacementMode() { initTechData(gameState.player.role); gameState.step = 'placement'; document.getElementById('setup-overlay').style.display = 'none'; document.body.classList.remove('setup-mode'); document.body.classList.add('placement-mode'); document.getElementById('hint-type').innerText = "全球总部"; document.getElementById('hint-region-name').innerText = regionsData[gameState.player.region].label; document.getElementById('placement-hint').style.display = 'block'; updateMapStyles(); }
    function generateTabs() { const roles = ['level0', 'level1', 'level2', 'level3']; let prodTabsHtml = "", techTabsHtml = "", intelTabsHtml = ""; roles.forEach(role => { const name = tierConfig[role].short; prodTabsHtml += `<div class="tab-btn" onclick="switchProductTab('${role}')" id="ptab-${role}">${name}</div>`; techTabsHtml += `<div class="tab-btn" onclick="switchTechTab('${role}')" id="ttab-${role}">${name}</div>`; intelTabsHtml += `<div class="tab-btn" onclick="switchIntelTab('${role}')" id="itab-${role}">${name}</div>`; }); document.getElementById('product-tabs').innerHTML = prodTabsHtml; document.getElementById('tech-tabs').innerHTML = techTabsHtml; document.getElementById('intel-tabs').innerHTML = intelTabsHtml; }
    function switchProductTab(role) { gameState.currentTabRole = role; document.querySelectorAll('#product-tabs .tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('ptab-' + role).classList.add('active'); updateProductUI(role); }
    function updateProductUI(role) { const isUnlocked = gameState.tech[role].unlocked; const mask = document.getElementById('product-locked-mask'); if (!isUnlocked) { mask.style.display = "flex"; return; } mask.style.display = "none"; const config = tierConfig[role]; const techState = gameState.tech[role]; const caps = [20, 50, 70, 100]; [0, 1, 2].forEach(idx => { const maxVal = caps[techState.specs[idx].level]; const slider = document.getElementById(`slider-${idx+1}`); document.getElementById(`label-spec-${idx+1}`).innerText = config.specs[idx]; document.getElementById(`max-spec-${idx+1}`).innerText = maxVal; if (parseInt(slider.value) > maxVal) slider.value = maxVal; const percentage = maxVal; slider.style.background = `linear-gradient(to right, rgba(255, 255, 255, 0.2) ${percentage}%, #111 ${percentage}%)`; slider.dataset.maxLimit = maxVal; }); document.getElementById('product-price').value = config.defaultPrice; updateProductStats(); }
    function switchTechTab(role) { gameState.techTabRole = role; document.querySelectorAll('#tech-tabs .tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('ttab-' + role).classList.add('active'); renderTechTree(role); }
    function renderTechTree(role) { const container = document.getElementById('tech-content'); const techState = gameState.tech[role]; const config = tierConfig[role]; if (!techState.unlocked) { container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center"><div class="text-gray-400 mb-4">该产业链尚未涉足。</div><button class="bg-green-700 hover:bg-green-600 text-white font-bold py-3 px-8 rounded border border-green-500" onclick="unlockSector('${role}')">成立研发机构<br><span class="text-xs font-normal">$${config.unlockCost}</span></button></div>`; return; } let html = `<div class="mb-4 text-xs text-green-400">当前产业分部: 运行中</div>`; config.specs.forEach((specName, specIdx) => { const treeData = config.techTree[specIdx]; const currentLevel = techState.specs[specIdx].level; html += `<div class="tech-row"><div class="tech-label">${specName}<br><span class="text-[11px] text-gray-600">${treeData.name}</span></div><div class="tech-track">`; treeData.nodes.forEach((nodeName, nodeIdx) => { const caps = [20, 50, 70, 100]; let stateClass = "locked"; if (nodeIdx <= currentLevel) stateClass = "unlocked"; else if (nodeIdx === currentLevel + 1) stateClass = "next-unlock"; const isSelected = gameState.selectedTechNode && gameState.selectedTechNode.role === role && gameState.selectedTechNode.specIdx === specIdx && gameState.selectedTechNode.nodeIdx === nodeIdx; if (isSelected) stateClass += " selected-node"; html += `<div class="tech-node-btn ${stateClass}" onclick="selectTechNode('${role}', ${specIdx}, ${nodeIdx})" title="${nodeName}"><span class="text-[10px] leading-tight text-center">${nodeName}</span>${stateClass === 'unlocked' ? `<span class="node-cap text-green-300">Lv.${caps[nodeIdx]}</span>` : ''}</div>`; }); html += `</div></div>`; }); container.innerHTML = html; }
    function selectTechNode(role, specIdx, nodeIdx) { gameState.selectedTechNode = { role, specIdx, nodeIdx }; renderTechTree(role); const treeData = tierConfig[role].techTree[specIdx]; const cost = treeData.costs[nodeIdx]; const currentLevel = gameState.tech[role].specs[specIdx].level; const panel = document.getElementById('tech-detail-panel'); let actionHtml = ""; if (nodeIdx <= currentLevel) actionHtml = `<div class="text-green-500 font-bold border border-green-500 px-3 py-1 rounded text-sm">已掌握 / MASTERED</div>`; else if (nodeIdx === currentLevel + 1) actionHtml = `<div class="flex flex-col items-end"><div class="text-yellow-400 text-sm mb-1">研发费用: $${cost}</div><button class="bg-green-700 hover:bg-green-600 text-white text-xs font-bold py-1 px-4 rounded border border-green-500" onclick="executePurchaseTech('${role}', ${specIdx}, ${nodeIdx}, ${cost})">立即研发</button></div>`; else actionHtml = `<div class="text-gray-600 text-sm border border-gray-700 px-3 py-1 rounded">需前置科技 / LOCKED</div>`; panel.innerHTML = `<div class="flex justify-between items-start w-full"><div class="flex-1 pr-4"><div class="text-white font-bold text-sm mb-1">${treeData.nodes[nodeIdx]} <span class="text-[10px] text-green-400 bg-green-900/30 px-1 rounded">上限 Lv.${[20,50,70,100][nodeIdx]}</span></div><div class="text-xs text-gray-400 leading-relaxed">${treeData.descs[nodeIdx]}</div></div>${actionHtml}</div>`; }
    function executePurchaseTech(role, specIdx, nodeIdx, cost) { 
        const bonus = getRegionBonus(role);
        const finalCost = cost * bonus.rdFactor; 
        if (spendCash(finalCost)) { gameState.tech[role].specs[specIdx].level = nodeIdx; selectTechNode(role, specIdx, nodeIdx); if (document.getElementById('product-window').classList.contains('open') && gameState.currentTabRole === role) updateProductUI(role); } 
    }
    function unlockSector(role) { if (spendCash(tierConfig[role].unlockCost)) { gameState.tech[role].unlocked = true; document.getElementById('tech-window').classList.remove('open'); enterBranchPlacementMode(role); } }
    function enterBranchPlacementMode(role) { gameState.placingBranch = role; gameState.step = 'branch_placement'; document.body.classList.add('branch-mode'); document.getElementById('hint-type').innerText = tierConfig[role].short + "分部"; document.getElementById('hint-region-name').innerText = "全球"; document.getElementById('placement-hint').style.display = 'block'; }

    const width = window.innerWidth; const height = window.innerHeight; const svg = d3.select("#map-container").append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${width} ${height}`); const g = svg.append("g"); const projection = d3.geoNaturalEarth1().scale(width / 5.5).translate([width / 2, height / 2]); const path = d3.geoPath().projection(projection); const zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", (e) => g.attr("transform", e.transform)); svg.call(zoom); let worldDataGlobal, countriesGlobal, idToRegionGlobal; const tooltip = d3.select("#tooltip");
    Promise.all([d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"), d3.json("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.json")]).then(([world, regionData]) => { d3.select("#loading").style("display", "none"); worldDataGlobal = world; countriesGlobal = world.objects.countries; idToRegionGlobal = {}; regionData.forEach(d => { let r = d.region; if (r === "Americas") { if (d["sub-region"] === "Northern America") { r = "North America"; } else if (d["sub-region"] === "Latin America and the Caribbean") { if (d["intermediate-region"] === "South America") r = "South America"; else r = "North America"; } } idToRegionGlobal[d["country-code"].padStart(3, "0")] = r; idToRegionGlobal[parseInt(d["country-code"])] = r; }); idToRegionGlobal["010"] = "Antarctica"; idToRegionGlobal["304"] = "North America"; drawMap(); drawMapObjects(); });
    function drawMap() { const regions = ["North America", "South America", "Europe", "Africa", "Asia", "Oceania", "Antarctica"]; regions.forEach(r => { const merged = topojson.merge(worldDataGlobal, countriesGlobal.geometries.filter(d => { const m = idToRegionGlobal[d.id]; return m === "Americas" ? r === "North America" : m === r; })); merged.regionName = r; g.append("path").datum(merged).attr("class", "region").attr("d", path).attr("fill", "#ccc").on("click", (e, d) => handleMapClick(e, d)).on("mouseover", function(e, d) { if (gameState.step !== 'playing') d3.select(this).style("fill-opacity", 0.4); }).on("mouseout", function() { if (gameState.step === 'playing') d3.select(this).transition().duration(500).style("fill-opacity", 0.15); else updateMapStyles(); }); }); g.append("path").datum(d3.geoGraticule()()).attr("d", path).attr("fill", "none").attr("stroke", "var(--primary-green)").attr("stroke-width", 0.5).attr("stroke-opacity", 0.05).style("pointer-events", "none"); }
    function handleMapClick(event, d) { const transform = d3.zoomTransform(svg.node()); const coords = projection.invert(transform.invert(d3.pointer(event, svg.node()))); if (gameState.step === 'placement') { if (d.regionName === gameState.player.region) startGame(coords); else { document.getElementById('placement-hint').classList.add('animate-bounce'); setTimeout(() => document.getElementById('placement-hint').classList.remove('animate-bounce'), 500); } } else if (gameState.step === 'branch_placement') { gameState.branches.push({ role: gameState.placingBranch, coords: coords, regionName: d.regionName }); drawMapObjects(); gameState.step = 'playing'; document.getElementById('placement-hint').style.display = 'none'; document.body.classList.remove('branch-mode'); toggleTechWindow(); renderTechTree(gameState.placingBranch); } }
    function updateMapStyles() { const colors = { "North America": "#00eaff", "South America": "#00ff88", "Europe": "#b48eff", "Africa": "#ffae00", "Asia": "#ff3366", "Oceania": "#00ccff", "Antarctica": "#5e737d" }; g.selectAll(".region").attr("fill", d => colors[d.regionName]).classed("target-region", d => d && d.regionName === gameState.player.region && gameState.step === 'placement'); }
    function drawMapObjects() { 
        g.selectAll(".tech-group").remove(); g.selectAll(".player-group").remove(); 
        const compNodes = g.selectAll(".tech-group").data(techCompanies).enter().append("g").attr("class", "tech-group").attr("transform", d => `translate(${projection(d.coords)[0]}, ${projection(d.coords)[1]})`).filter(d => projection(d.coords));
        compNodes.each(function(d) { 
            const roleConfig = tierConfig[d.role];
            if (roleConfig && roleConfig.topComp.acquired) return; 
            d3.select(this).append("circle").attr("class", "tech-node-pulse").attr("r", 2).style("animation-delay", () => Math.random()*2+"s");
            d3.select(this).append("circle").attr("class", "tech-node-circle").attr("r", 4).on("mouseover", (e, dd) => showTooltip(e, dd)).on("mousemove", moveTooltip).on("mouseout", hideTooltip);
        });
        const playerNodes = g.selectAll(".player-group").data(gameState.branches).enter().append("g").attr("class", "player-group").attr("transform", d => `translate(${projection(d.coords)[0]}, ${projection(d.coords)[1]})`);
        playerNodes.append("circle").attr("class", d => d.role === gameState.player.role ? "tech-node-pulse player-node-pulse" : "tech-node-pulse branch-node-pulse").attr("r", 2);
        playerNodes.append("circle").attr("class", d => d.role === gameState.player.role ? "tech-node-circle player-node-circle" : "tech-node-circle branch-node-circle").attr("r", 6).on("mouseover", (e, d) => showTooltip(e, { name: gameState.player.name, type: d.role === gameState.player.role ? "GLOBAL HQ" : `${tierConfig[d.role].short} BRANCH`, desc: d.role === gameState.player.role ? "公司全球指挥中心" : `专注于 ${tierConfig[d.role].short} 的研发与生产中心` })).on("mousemove", moveTooltip).on("mouseout", hideTooltip);
    }
    function showTooltip(e, d) { tooltip.style("opacity", 1).html(`<div class="border-b border-green-800 pb-1 mb-1 font-bold text-white">${d.name.toUpperCase()}</div><div class="text-[10px] bg-green-900 text-green-300 inline-block px-1 mb-1">${d.type}</div><div class="text-xs text-gray-300">${d.desc}</div>`); }
    function moveTooltip(e) { tooltip.style("left", (e.pageX+20)+"px").style("top", (e.pageY-20)+"px"); }
    function hideTooltip() { tooltip.style("opacity", 0); }
    window.addEventListener("resize", () => svg.attr("viewBox", `0 0 ${window.innerWidth} ${window.innerHeight}`));
    </script>

</body>
</html>
