<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球战略指挥系统 // 启动程序</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-green: #00ff9d;
            --dim-green: #0f392b;
            --bg-dark: #020604;
            --grid-line: rgba(0, 255, 157, 0.08);
            --panel-bg: rgba(2, 10, 5, 0.95);
            --highlight: #ffffff;
            --danger: #ff3366;
            --score-gold: #ffae00;
            --locked-gray: #333333;
            --intel-blue: #00ccff;
            --market-purple: #d946ef;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-dark);
            font-family: 'Share Tech Mono', monospace;
            color: var(--primary-green);
            user-select: none;
        }

        /* ================= 地图样式 ================= */
        #map-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 40px 40px;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
            z-index: 0;
            transition: filter 0.5s;
        }
        
        body.setup-mode #map-container { filter: blur(4px) brightness(0.5); }

        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 1;
            opacity: 0.3;
        }

        .region {
            stroke: var(--primary-green);
            stroke-width: 1px;
            stroke-opacity: 0.3;
            stroke-linejoin: round;
            transition: all 0.3s;
            cursor: pointer;
            fill-opacity: 0.2;
        }

        body.placement-mode .region:not(.target-region) {
            fill-opacity: 0.05;
            stroke-opacity: 0.1;
            cursor: not-allowed;
        }
        
        body.placement-mode .region.target-region {
            fill: var(--primary-green);
            fill-opacity: 0.3;
            stroke: #fff;
            stroke-width: 2px;
            stroke-dasharray: 10 5;
            animation: map-pulse 2s infinite;
            cursor: crosshair;
        }
        
        body.branch-mode .region {
            fill: var(--primary-green);
            fill-opacity: 0.1;
            cursor: crosshair;
        }
        body.branch-mode .region:hover {
            fill-opacity: 0.4;
            stroke: #fff;
        }

        @keyframes map-pulse {
            0% { fill-opacity: 0.2; }
            50% { fill-opacity: 0.4; }
            100% { fill-opacity: 0.2; }
        }

        .tech-node-pulse {
            fill: none;
            stroke: var(--primary-green);
            stroke-width: 1.5px;
            opacity: 0;
            transform-origin: center;
            animation: radar-pulse 2s infinite;
        }
        @keyframes radar-pulse {
            0% { r: 2; opacity: 1; stroke-width: 2px; }
            100% { r: 15; opacity: 0; stroke-width: 0px; }
        }
        
        .player-node-pulse { stroke: #ffae00; }
        .player-node-circle { fill: #ffae00; stroke: #fff; stroke-width: 2px; }
        .branch-node-pulse { stroke: #00ccff; }
        .branch-node-circle { fill: #00ccff; stroke: #fff; stroke-width: 2px; }

        /* ================= UI 基础 ================= */
        .game-ui { display: none; opacity: 0; transition: opacity 1s; }
        .game-ui.active { display: block; opacity: 1; }

        .news-ticker-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 36px;
            background: var(--panel-bg);
            border-bottom: 1px solid rgba(0, 255, 157, 0.3);
            z-index: 50;
            display: flex; align-items: center; overflow: hidden; white-space: nowrap;
        }
        .news-label {
            background: var(--primary-green); color: #000; padding: 0 12px; height: 100%;
            display: flex; align-items: center; font-weight: bold; font-size: 14px; z-index: 51;
        }
        .news-content {
            display: inline-block; padding-left: 100%;
            animation: ticker 30s linear infinite;
            color: #a3e6c7; font-size: 14px;
        }
        @keyframes ticker { 100% { transform: translate(-100%, 0); } }

        .bottom-menu-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 64px;
            background: linear-gradient(to top, rgba(0,10,5,1), rgba(0,10,5,0.8));
            border-top: 1px solid var(--primary-green);
            z-index: 50;
            display: flex; justify-content: center; align-items: center; gap: 2px; padding: 0 20px;
        }
        .menu-btn {
            background: rgba(0, 255, 157, 0.05);
            border: 1px solid rgba(0, 255, 157, 0.2);
            color: var(--primary-green);
            padding: 0 24px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-family: 'Share Tech Mono'; font-size: 14px;
            transition: all 0.2s; min-width: 120px;
        }
        .menu-btn:hover {
            background: rgba(0, 255, 157, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 0 10px var(--primary-green);
        }
        .btn-primary {
            background: var(--primary-green); color: #000; font-weight: bold;
        }
        .btn-primary:hover {
            background: #fff;
            box-shadow: 0 0 15px var(--primary-green);
        }

        /* ================= 侧边面板 ================= */
        .overlay-panel {
            position: absolute; inset: 0; z-index: 100;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            transition: opacity 0.5s;
        }
        
        .side-window {
            position: absolute;
            top: 36px; bottom: 64px; right: -600px; width: 550px;
            background: rgba(5, 15, 10, 0.98);
            border-left: 1px solid var(--primary-green);
            box-shadow: -10px 0 30px rgba(0,0,0,0.8);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 60;
            display: flex; flex-direction: column;
        }
        .side-window.open { right: 0; }

        #intel-window { border-left-color: var(--intel-blue); }
        #intel-window h2 { color: var(--intel-blue); }
        
        #market-window { border-left-color: var(--market-purple); }
        #market-window h2 { color: var(--market-purple); }

        .setup-panel {
            width: 900px; max-width: 95vw;
            background: rgba(5, 15, 10, 0.95);
            border: 1px solid var(--primary-green);
            box-shadow: 0 0 50px rgba(0, 255, 157, 0.1);
            display: grid; grid-template-columns: 300px 1fr;
            height: 600px; position: relative;
        }

        .corner-deco { position: absolute; width: 10px; height: 10px; border: 2px solid var(--primary-green); }
        .tl { top: -2px; left: -2px; border-right: 0; border-bottom: 0; }
        .tr { top: -2px; right: -2px; border-left: 0; border-bottom: 0; }
        .bl { bottom: -2px; left: -2px; border-right: 0; border-top: 0; }
        .br { bottom: -2px; right: -2px; border-left: 0; border-top: 0; }

        h2 { font-size: 24px; margin-bottom: 20px; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        input[type="text"], input[type="number"] {
            width: 100%; background: #000; border: 1px solid #333;
            color: #fff; padding: 10px; font-family: 'Share Tech Mono';
            font-size: 16px; outline: none;
        }
        input[type="text"]:focus, input[type="number"]:focus { border-color: var(--primary-green); }

        input[type="range"] {
            width: 100%; -webkit-appearance: none; background: transparent;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            border-radius: 50%; background: var(--primary-green);
            margin-top: -5px; cursor: pointer; box-shadow: 0 0 5px var(--primary-green);
            border: 2px solid #fff;
        }
        
        .tabs { display: flex; border-bottom: 1px solid #333; }
        .tab-btn {
            flex: 1; padding: 15px; text-align: center; cursor: pointer;
            color: #888; border-bottom: 2px solid transparent; font-size: 12px;
        }
        .tab-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tab-btn.active {
            color: var(--primary-green); border-bottom-color: var(--primary-green);
            background: rgba(0,255,157,0.05);
        }

        #intel-tabs .tab-btn.active {
            color: var(--intel-blue); border-bottom-color: var(--intel-blue);
            background: rgba(0, 204, 255, 0.05);
        }

        .tech-row { display: flex; align-items: center; margin-bottom: 20px; }
        .tech-label { width: 100px; font-size: 10px; color: #888; text-align: right; padding-right: 15px; }
        .tech-track { flex: 1; display: flex; gap: 10px; position: relative; }
        .tech-track::before { 
            content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 2px; 
            background: #333; z-index: 0; 
        }
        .tech-node-btn {
            width: 60px; height: 40px; background: #111; border: 1px solid #444; z-index: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; transition: all 0.2s;
        }
        .tech-node-btn.unlocked {
            background: rgba(0,255,157,0.1); border-color: var(--primary-green); color: white;
        }
        .tech-node-btn.next-unlock {
            background: #222; border-color: #ffff00; color: #ffff00;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.2);
        }
        .tech-node-btn.locked {
            background: #000; border-color: #222; color: #444; cursor: not-allowed;
        }
        .tech-node-btn.selected-node {
            border-color: #fff; box-shadow: 0 0 15px white;
        }
        
        .node-cap { font-size: 14px; font-weight: bold; }
        .node-cost { font-size: 9px; margin-top: 2px; }

        .chain-card {
            border: 1px solid #333; padding: 15px; cursor: pointer;
            margin-bottom: 15px; opacity: 0.6; transition: all 0.2s;
        }
        .chain-card.selected {
            border-color: var(--primary-green); background: rgba(0, 255, 157, 0.05); opacity: 1;
        }
        
        .region-select-btn {
            display: block; width: 100%; padding: 10px; margin-bottom: 5px;
            background: transparent; border: 1px solid transparent; color: #888; text-align: left;
        }
        .region-select-btn.active {
            border: 1px solid var(--primary-green); color: var(--primary-green); background: rgba(0, 255, 157, 0.1);
        }

        #start-btn {
            width: 100%; padding: 15px; margin-top: 20px;
            background: var(--primary-green); color: #000; border: none;
            font-weight: bold; font-family: 'Share Tech Mono'; font-size: 18px;
            cursor: pointer; opacity: 0.5; pointer-events: none;
        }
        #start-btn.ready { opacity: 1; pointer-events: all; box-shadow: 0 0 20px var(--primary-green); }

        #tooltip {
            position: absolute; padding: 12px; background: rgba(2, 10, 5, 0.95);
            border: 1px solid var(--primary-green); color: var(--primary-green);
            pointer-events: none; font-size: 14px; box-shadow: 0 0 15px rgba(0, 255, 157, 0.3);
            opacity: 0; transition: opacity 0.1s; z-index: 200; min-width: 180px;
        }

        /* 放置提示 */
        #placement-hint {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); border: 1px solid var(--primary-green);
            padding: 20px 40px; z-index: 90; display: none; text-align: center;
        }

        /* 市场份额条形图 */
        .market-bar-container {
            width: 100%; height: 24px; background: #111; display: flex; margin-bottom: 8px; border: 1px solid #333;
        }
        .market-bar-segment {
            height: 100%; display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #000; font-weight: bold; overflow: hidden; white-space: nowrap;
            transition: width 0.5s;
        }
        
        /* 企业列表项 */
        .company-item {
            padding: 10px; border-bottom: 1px solid #222; cursor: pointer; transition: background 0.2s;
        }
        .company-item:hover { background: rgba(255,255,255,0.05); }
        .company-item.active { background: rgba(0, 204, 255, 0.1); border-left: 2px solid var(--intel-blue); }
        
        .spec-comparison-row {
            display: flex; align-items: center; margin-bottom: 4px; font-size: 10px;
        }
        .spec-label { width: 80px; color: #888; text-align: right; margin-right: 10px; }
        .spec-bar-bg { flex: 1; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .spec-bar-fill { height: 100%; background: var(--intel-blue); }
        .spec-val { width: 30px; text-align: right; color: #fff; margin-left: 5px; }

        /* Chart */
        #valuation-chart { width: 100%; height: 150px; background: #111; border: 1px solid #333; }

    </style>
</head>
<body class="setup-mode">

    <div class="scanline"></div>

    <!-- ==================== 游戏 UI ==================== -->
    <div class="game-ui">
        <div class="news-ticker-container">
            <div class="news-label">GLOBAL_FEED //</div>
            <div class="news-content" id="news-content"></div>
        </div>

        <!-- 左上角 HUD -->
        <div class="absolute top-[60px] left-5 z-40 pointer-events-none">
            <div class="text-2xl font-bold text-white tracking-widest"><span id="hud-company-name">UNKNOWN</span> <span class="text-[var(--primary-green)]">CORP</span></div>
            <div class="text-xs text-green-400 opacity-70 mt-1">// SECTOR: <span id="hud-sector">--</span> // REGION: <span id="hud-region">--</span></div>
            <div class="text-lg font-bold text-white mt-2 border-t border-green-900/50 pt-1" id="date-display">2030-01</div>
        </div>

        <!-- 右上角 HUD -->
        <div class="absolute top-[60px] right-5 z-40">
            <div class="border border-green-500/30 bg-black/80 p-3 text-right">
                <div class="text-xs text-gray-400">CASH RESERVES</div>
                <div class="text-xl text-white font-bold">$<span id="cash-display">--</span> B</div>
                <div class="text-[10px] text-green-500" id="profit-display">+0.0 B / month</div>
            </div>
        </div>

        <!-- 底部菜单 -->
        <div class="bottom-menu-bar">
            <button class="menu-btn" onclick="toggleIntelWindow()">全球情报<br><span class="text-[10px] opacity-50">INTEL</span></button>
            <button class="menu-btn" onclick="toggleTechWindow()">核心研发<br><span class="text-[10px] opacity-50">R&D LAB</span></button>
            <button class="menu-btn" onclick="toggleMarketWindow()">资本运作<br><span class="text-[10px] opacity-50">MARKET</span></button>
            <button class="menu-btn">秘密行动<br><span class="text-[10px] opacity-50">BLACK OPS</span></button>
            <div class="w-px h-8 bg-green-800 mx-2"></div>
            <button class="menu-btn btn-primary border-green-500" onclick="toggleProductWindow()">
                发布产品<br><span class="text-[10px] opacity-50">LAUNCH</span>
            </button>
        </div>
    </div>

    <!-- ==================== 1. 全球情报窗口 ==================== -->
    <div id="intel-window" class="side-window">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-blue-900/20">
            <h2 class="text-xl m-0 border-none p-0 text-[var(--intel-blue)]">全球情报中心</h2>
            <button class="text-gray-400 hover:text-white" onclick="toggleIntelWindow()">[X]</button>
        </div>
        <div class="tabs" id="intel-tabs"></div>
        <div class="flex-1 overflow-y-auto p-4 flex flex-col">
            <div class="mb-6">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-sm text-gray-400 font-bold">市场总规模 (TAM)</span>
                    <span class="text-xl text-white font-bold" id="market-size-display">$0 B</span>
                </div>
                <div class="market-bar-container rounded" id="market-share-bar"></div>
                <div class="flex justify-between text-[10px] text-gray-500 mt-1"><span>DOMINANCE</span><span>FRAGMENTATION</span></div>
            </div>
            <div class="mb-4 flex-1">
                <div class="text-xs text-[var(--intel-blue)] font-bold border-b border-gray-800 pb-1 mb-2">主要竞争实体</div>
                <div id="competitor-list" class="flex flex-col"></div>
            </div>
            <div id="product-detail-panel" class="bg-black/50 border border-gray-700 p-4 rounded min-h-[150px]">
                <div class="text-center text-gray-500 text-xs mt-4">请选择上方企业查看产品分析...</div>
            </div>
        </div>
    </div>

    <!-- ==================== 2. 产品发布窗口 ==================== -->
    <div id="product-window" class="side-window">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-green-900/20">
            <h2 class="text-xl text-white m-0 border-none p-0">产品设计中心</h2>
            <button class="text-gray-400 hover:text-white" onclick="toggleProductWindow()">[X]</button>
        </div>
        <div class="tabs" id="product-tabs"></div>
        <div class="p-6 overflow-y-auto flex-1 relative">
            <div id="product-locked-mask" class="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center" style="display: none;">
                <div class="text-red-500 text-xl font-bold mb-2">SECTOR LOCKED</div>
                <div class="text-gray-400 text-sm text-center max-w-xs">该产业链尚未建立研发机构。<br>请前往 [核心研发] 成立分部。</div>
            </div>
            <div class="mb-6">
                <label class="text-xs text-gray-400 block mb-2">产品代号 / CODENAME</label>
                <input type="text" id="product-name" placeholder="e.g. Neural-Link X1" value="Project Alpha">
            </div>
            <div class="mb-6">
                <label class="text-xs text-green-400 block mb-3 font-bold border-b border-gray-800 pb-1">技术规格 / SPECS</label>
                <div class="mb-4"><div class="flex justify-between text-xs mb-1"><span id="label-spec-1" class="text-white">--</span><span class="text-green-400"><span id="val-spec-1">20</span> / <span id="max-spec-1" class="text-gray-500">20</span></span></div><input type="range" min="1" max="100" value="20" oninput="updateProductStats()" id="slider-1"></div>
                <div class="mb-4"><div class="flex justify-between text-xs mb-1"><span id="label-spec-2" class="text-white">--</span><span class="text-green-400"><span id="val-spec-2">20</span> / <span id="max-spec-2" class="text-gray-500">20</span></span></div><input type="range" min="1" max="100" value="20" oninput="updateProductStats()" id="slider-2"></div>
                <div class="mb-4"><div class="flex justify-between text-xs mb-1"><span id="label-spec-3" class="text-white">--</span><span class="text-green-400"><span id="val-spec-3">20</span> / <span id="max-spec-3" class="text-gray-500">20</span></span></div><input type="range" min="1" max="100" value="20" oninput="updateProductStats()" id="slider-3"></div>
            </div>
            
            <!-- 显示产品力与竞争力 (新) -->
            <div class="grid grid-cols-2 gap-2 mb-4">
                 <div class="bg-gray-900 p-2 rounded border border-gray-700">
                    <div class="text-[10px] text-gray-400">产品力 (Potential Cap)</div>
                    <div class="text-lg text-white font-bold" id="calc-power">0%</div>
                 </div>
                 <div class="bg-gray-900 p-2 rounded border border-gray-700">
                    <div class="text-[10px] text-gray-400">竞争力 (Actual Grab)</div>
                    <div class="text-lg font-bold" id="calc-score">0</div>
                 </div>
            </div>

            <div class="bg-black/50 p-4 border border-gray-700 rounded mb-4">
                <div class="flex justify-between items-center mb-2"><span class="text-xs text-gray-400">研发/生产成本 (Cost)</span><span class="text-sm text-red-400">$<span id="calc-cost">0</span></span></div>
                <div class="flex justify-between items-center mb-4"><span class="text-xs text-gray-400">建议售价 (Price)</span><div class="flex items-center"><span class="text-gray-500 text-xs mr-1">$</span><input type="number" id="product-price" class="w-20 p-1 text-right text-sm" value="1000" oninput="updateProfit()"></div></div>
                <div class="h-px bg-gray-700 mb-2"></div>
                <div class="flex justify-between items-center mb-2"><span class="text-xs text-white font-bold">利润率 (Margin)</span><span class="text-lg font-bold" id="calc-margin">0%</span></div>
            </div>
            <button id="launch-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-[0_0_10px_rgba(0,255,0,0.3)] transition-all" onclick="launchProduct()">确认发布 / LAUNCH</button>
        </div>
    </div>

    <!-- ==================== 3. 研发中心窗口 ==================== -->
    <div id="tech-window" class="side-window">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-green-900/20">
            <h2 class="text-xl text-white m-0 border-none p-0">核心研发实验室</h2>
            <button class="text-gray-400 hover:text-white" onclick="toggleTechWindow()">[X]</button>
        </div>
        <div class="tabs" id="tech-tabs"></div>
        <div class="p-6 overflow-y-auto flex-1 relative" id="tech-content"></div>
        <div id="tech-detail-panel" class="p-4 border-t border-gray-800 bg-black min-h-[120px] flex flex-col justify-center"><div class="text-center text-gray-500 text-xs">点击上方科技节点查看详细信息...</div></div>
    </div>

    <!-- ==================== 4. 资本运作窗口 (新) ==================== -->
    <div id="market-window" class="side-window">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-purple-900/20">
            <h2 class="text-xl m-0 border-none p-0 text-[var(--market-purple)]">资本运作中心</h2>
            <button class="text-gray-400 hover:text-white" onclick="toggleMarketWindow()">[X]</button>
        </div>
        <div class="p-4 overflow-y-auto flex-1">
            <div class="mb-4">
                <div class="text-xs text-gray-500 mb-2">市值走势 (MARKET CAP)</div>
                <svg id="valuation-chart" viewBox="0 0 300 100"></svg>
            </div>
            <div class="text-xs text-[var(--market-purple)] font-bold border-b border-gray-800 pb-1 mb-3">并购目标 (M&A TARGETS)</div>
            <div id="ma-list" class="space-y-3">
                <!-- JS Generated -->
            </div>
        </div>
    </div>

    <!-- ==================== 放置提示 ==================== -->
    <div id="placement-hint">
        <h2 class="text-white border-none mb-0 text-xl">建立<span id="hint-type">总部</span></h2>
        <p class="text-green-400 text-sm mt-2">请点击 <span id="hint-region-name" class="font-bold text-white">区域</span> 地图上的任意位置</p>
    </div>

    <!-- ==================== 开始设置面板 ==================== -->
    <div id="setup-overlay" class="overlay-panel">
        <div class="setup-panel">
            <div class="corner-deco tl"></div><div class="corner-deco tr"></div>
            <div class="corner-deco bl"></div><div class="corner-deco br"></div>
            <div class="setup-sidebar border-r border-gray-800 p-8 bg-green-900/5">
                <h2>初始化参数</h2>
                <div class="input-group mb-5">
                    <label class="block text-xs text-gray-500 mb-1">公司名称 / COMPANY NAME</label>
                    <input type="text" id="company-name-input" placeholder="例如: CyberDyne Systems" maxlength="15">
                </div>
                <div class="input-group">
                    <label class="block text-xs text-gray-500 mb-1">选择大区 / REGION</label>
                    <div id="region-list"></div>
                </div>
                <div class="mt-5 text-xs text-gray-400 border-t border-gray-800 pt-3"><div id="region-desc">请选择一个起始大区...</div></div>
            </div>
            <div class="setup-main p-8 overflow-y-auto">
                <h2>选择生态位 / ROLE</h2>
                <p class="text-xs text-gray-500 mb-4">这决定了你的起步技术栈。</p>
                <div class="chain-container flex flex-col gap-3">
                    <div class="chain-card" onclick="selectRole('level0', this)"><div class="text-lg font-bold text-white">TIER 0: 源头设备</div><div class="text-xs text-gray-500 mt-1">制造光刻机。技术门槛极高，垄断地位。</div><div class="text-[10px] text-green-500 mt-1">对手: ASML</div></div>
                    <div class="chain-card" onclick="selectRole('level1', this)"><div class="text-lg font-bold text-white">TIER 1: 晶圆代工</div><div class="text-xs text-gray-500 mt-1">超级工厂。资本密集，产能即正义。</div><div class="text-[10px] text-green-500 mt-1">对手: TSMC</div></div>
                    <div class="chain-card" onclick="selectRole('level2', this)"><div class="text-lg font-bold text-white">TIER 2: 核心架构</div><div class="text-xs text-gray-500 mt-1">设计芯片。高利润，研发竞争激烈。</div><div class="text-[10px] text-green-500 mt-1">对手: NVIDIA</div></div>
                    <div class="chain-card" onclick="selectRole('level3', this)"><div class="text-lg font-bold text-white">TIER 3: 终端平台</div><div class="text-xs text-gray-500 mt-1">面向消费者。现金流之王。</div><div class="text-[10px] text-green-500 mt-1">对手: Apple, Tesla</div></div>
                </div>
                <button id="start-btn" onclick="enterPlacementMode()">初始化并选址 / DEPLOY</button>
            </div>
        </div>
    </div>

    <div id="loading" class="absolute inset-0 flex items-center justify-center z-50 bg-black">
        <div class="text-xl tracking-[0.5em] text-[var(--primary-green)] animate-pulse">
            LOADING_GEO_DATA...
        </div>
    </div>

    <div id="tooltip"></div>
    <div id="map-container"></div>

    <script>
        // =================== 游戏数据结构 ===================
        const gameState = {
            player: { name: "", region: "", role: "", coords: null, cash: 999999.0, valuation: 0 }, 
            branches: [], // {role, coords, regionName}
            step: 'setup',
            currentTabRole: 'level0',
            techTabRole: 'level0',
            intelTabRole: 'level0',
            placingBranch: null,
            tech: {},
            selectedTechNode: null,
            selectedCompetitor: null, // 情报窗口保持选中
            marketData: {},
            products: {},
            date: { year: 2030, month: 1 },
            valuationHistory: { player: [], level0:[], level1:[], level2:[], level3:[] } // 历史数据用于绘图
        };

        // 区域加成配置 (Bonus)
        const regionBonuses = {
            "North America": { costFactor: 1.0, rdFactor: 0.8, compBoost: 1.1, label: "硅谷红利: 研发费用-20%, 竞争力+10%" },
            "Asia": { costFactor: 0.8, rdFactor: 1.1, compBoost: 1.0, label: "制造中心: 生产成本-20%" },
            "Europe": { costFactor: 1.1, rdFactor: 0.9, compBoost: 1.05, label: "精密工程: 研发费用-10%, 竞争力+5%" },
            "South America": { costFactor: 0.9, rdFactor: 1.2, compBoost: 0.9, label: "新兴市场: 成本-10%, 研发+20%" },
            "Oceania": { costFactor: 1.2, rdFactor: 1.0, compBoost: 1.0, label: "孤立市场: 无特殊加成" },
            "Africa": { costFactor: 0.7, rdFactor: 1.5, compBoost: 0.8, label: "未开发地: 成本-30%, 研发+50%" },
            "Antarctica": { costFactor: 2.0, rdFactor: 2.0, compBoost: 0.5, label: "极地科研: 成本极高" }
        };

        // 产业链配置
        const tierConfig = {
            'level0': {
                name: "Tier 0: 核心设备", short: "设备/光刻", specs: ["加工精度", "产出效率", "系统稳定性"],
                initialMarket: 120,
                topComp: { name: "ASML", share: 85, flagship: "High-NA EUV", specs: [95, 90, 90], score: 98, acquired: false },
                avgComp: { name: "行业平均", flagship: "Standard Litho", specs: [40, 50, 60], score: 45 },
                unlockCost: 5000, baseCost: 500, defaultPrice: 2000,
                techTree: [{name:"光源系统",nodes:["DUV 透镜","浸没式","EUV 光学","High-NA"],costs:[0,2000,5000,10000],descs:["基础深紫外线光刻。","液体增强折射率。","极紫外线反射光学。","埃米级工艺入场券。"]},{name:"工件台",nodes:["步进电机","双工件台","磁悬浮","量子同步"],costs:[0,1500,4000,8000],descs:["基础步进式扫描。","双台并行处理。","纳米级精准控制。","消除机械误差。"]},{name:"环境控制",nodes:["洁净室","温控系统","真空腔体","零重力模拟"],costs:[0,1000,3000,6000],descs:["标准百级洁净。","0.001度温控。","减少EUV能量损耗。","消除重力微变形。"]}],
                calcCost: (v1,v2,v3)=>500+Math.pow(v1,1.8)*0.5+v2*5+v3*3
            },
            'level1': {
                name: "Tier 1: 晶圆制造", short: "晶圆/制造", specs: ["晶体管密度", "制程良率", "生产周期"],
                initialMarket: 150,
                topComp: { name: "TSMC", share: 55, flagship: "N2 Process", specs: [92, 95, 85], score: 95, acquired: false },
                avgComp: { name: "行业平均", flagship: "Legacy Node", specs: [30, 80, 50], score: 50 },
                unlockCost: 10000, baseCost: 300, defaultPrice: 1000,
                techTree: [{name:"制程架构",nodes:["Planar","FinFET","GAAFET","3D Stacking"],costs:[0,3000,8000,15000],descs:["平面晶体管。","鳍式场效应。","全环绕栅极。","垂直堆叠。"]},{name:"检测系统",nodes:["人工镜检","AOI 光学","AI 缺陷识别","自愈合材料"],costs:[0,1500,4000,7000],descs:["显微抽检。","自动光学检测。","深度学习分析。","纳米材料修复。"]},{name:"流水线",nodes:["批次处理","连续流","数字孪生","原子级组装"],costs:[0,2000,5000,9000],descs:["批次流转。","优化节拍。","全虚拟模拟。","无缺陷制造。"]}],
                calcCost: (v1,v2,v3)=>Math.max(100,300+Math.pow(v1,1.5)*0.8-(v2-50)*2+v3*2)
            },
            'level2': {
                name: "Tier 2: 芯片设计", short: "架构/芯片", specs: ["算力性能", "能效比", "通用性"],
                initialMarket: 500,
                topComp: { name: "NVIDIA", share: 80, flagship: "B200 Blackwell", specs: [98, 85, 90], score: 99, acquired: false },
                avgComp: { name: "行业平均", flagship: "Generic CPU", specs: [40, 50, 70], score: 55 },
                unlockCost: 8000, baseCost: 100, defaultPrice: 800,
                techTree: [{name:"计算核心",nodes:["FP32 Core","Tensor Core","Transformer","类脑架构"],costs:[0,2500,6000,12000],descs:["通用计算单元。","矩阵运算优化。","大模型优化。","模拟生物突触。"]},{name:"封装技术",nodes:["2D Layout","Chiplet","SoIC","光互连"],costs:[0,2000,5000,10000],descs:["平面封装。","小芯片异构。","系统级集成。","片间光通讯。"]},{name:"软件栈",nodes:["基础驱动","统一内存","Omniverse","AGI 协议"],costs:[0,1500,4000,8000],descs:["基础桥梁。","显存共享。","数字孪生底座。","通用AI接口。"]}],
                calcCost: (v1,v2,v3)=>100+(v1*v2)/150+v3*4
            },
            'level3': {
                name: "Tier 3: 终端平台", short: "终端/平台", specs: ["用户体验", "硬件耐久", "生态整合"],
                initialMarket: 3000,
                topComp: { name: "Apple", share: 25, flagship: "iPhone 17 Pro", specs: [90, 95, 95], score: 97, acquired: false },
                avgComp: { name: "行业平均", flagship: "Commodity Device", specs: [50, 50, 40], score: 50 },
                unlockCost: 6000, baseCost: 200, defaultPrice: 1200,
                techTree: [{name:"交互方式",nodes:["多点触控","视网膜屏","空间计算","脑机接口"],costs:[0,3000,7000,14000],descs:["手指操作。","超人眼精度。","手势/眼动。","脑机接口。"]},{name:"材料科学",nodes:["铝合金","钛金属","超瓷晶","液态金属"],costs:[0,1500,3000,6000],descs:["易加工。","航天级强度。","透明陶瓷。","非晶态合金。"]},{name:"生态系统",nodes:["应用商店","云同步","连续互通","蜂群思维"],costs:[0,2500,6000,11000],descs:["软件分发。","数据实时备份。","跨设备接力。","全球算力共享。"]}],
                calcCost: (v1,v2,v3)=>200+v1*3+v2*2+Math.pow(v3,1.6)*0.4
            }
        };

        const regionsData = {
            "North America": { diff: "Normal", label: "北美战区", class:"text-green-400", desc: "资本充裕，市场巨大。" },
            "Asia": { diff: "Hard", label: "泛亚细亚", class:"text-red-400", desc: "制造中心，地缘风险高。" },
            "Europe": { diff: "Medium", label: "欧罗巴", class:"text-yellow-400", desc: "科研扎实，法规严格。" },
            "South America": { diff: "Hard", label: "南美洲", class:"text-red-400", desc: "资源丰富，基建薄弱。" },
            "Oceania": { diff: "Hard", label: "大洋洲", class:"text-yellow-400", desc: "偏安一隅，隐蔽性强。" },
            "Africa": { diff: "Extreme", label: "非洲", class:"text-red-500", desc: "未经开发的处女地。" }
        };

        // 初始对手
        const techCompanies = [
            { name: "Apple", coords: [-122.03, 37.32], type: "Platform", id: "Apple", role: "level3" },
            { name: "NVIDIA", coords: [-121.95, 37.35], type: "Architect", id: "NVIDIA", role: "level2" },
            { name: "TSMC", coords: [120.96, 24.81], type: "Foundry", id: "TSMC", role: "level1" },
            { name: "ASML", coords: [5.40, 51.41], type: "Equipment", id: "ASML", role: "level0" }
        ];

        const newsItems = ["台积电 2nm 良率提升", "北美算力需求激增", "海底光缆信号异常", "欧盟启动反垄断调查", "量子计算原型机测试"];

        // =================== 核心逻辑: 游戏循环 & 经济 ===================
        
        function startGame(coords) {
            gameState.step = 'playing';
            gameState.player.coords = coords;
            // 记录分部并附带区域信息
            const rName = gameState.player.region;
            gameState.branches.push({ role: gameState.player.role, coords: coords, regionName: rName });

            document.getElementById('placement-hint').style.display = 'none';
            document.body.classList.remove('placement-mode');
            
            drawMapObjects();
            document.querySelector('.game-ui').classList.add('active');
            
            document.getElementById('hud-company-name').innerText = gameState.player.name.toUpperCase();
            document.getElementById('hud-sector').innerText = tierConfig[gameState.player.role].short;
            document.getElementById('hud-region').innerText = rName.toUpperCase();
            updateCashDisplay();

            const newsContent = document.getElementById('news-content');
            const t = newsItems.join(" &nbsp;///&nbsp; ");
            newsContent.innerHTML = t + " &nbsp;///&nbsp; " + t;

            // 初始化市场数据
            ['level0', 'level1', 'level2', 'level3'].forEach(role => {
                const topComp = tierConfig[role].topComp;
                gameState.marketData[role] = {
                    marketSize: tierConfig[role].initialMarket,
                    // 份额: 玩家, 巨头, 其他
                    shares: { player: 0, top: topComp.share, avg: 100 - topComp.share },
                    // 目标份额
                    targets: { player: 0 },
                    margin: 0 
                };
            });

            generateTabs(); 
            updateMapStyles();

            // 启动游戏循环 (1秒 Tick)
            setInterval(gameTick, 1000);
        }

        function gameTick() {
            if (gameState.step !== 'playing') return;

            // 1. 时间推进
            gameState.date.month++;
            if (gameState.date.month > 12) { gameState.date.month = 1; gameState.date.year++; }
            document.getElementById('date-display').innerText = `${gameState.date.year}-${String(gameState.date.month).padStart(2,'0')}`;

            let totalProfit = 0;
            gameState.player.valuation = 0;

            ['level0', 'level1', 'level2', 'level3'].forEach(role => {
                const data = gameState.marketData[role];
                const config = tierConfig[role];

                // 2. 市场规模自然增长 (0.2%)
                data.marketSize *= 1.002;

                // 3. 市场份额动态平衡算法 (归一化)
                // 玩家向目标份额逼近
                if (data.targets.player > data.shares.player) {
                    data.shares.player += (data.targets.player - data.shares.player) * 0.05;
                } else {
                    data.shares.player -= (data.shares.player - data.targets.player) * 0.05;
                }
                
                // 剩余份额分配给 Top 和 Avg
                let remaining = 100 - data.shares.player;
                if (remaining < 0) remaining = 0;
                
                // 如果巨头被收购，份额全部归玩家，remaining给Avg
                if (config.topComp.acquired) {
                   // 此时玩家继承了巨头的份额，playerShare 应该包含原Top份额
                   // 简化逻辑: 收购时，playerShare瞬间增加，之后 target 维持高位
                   // 这里只处理正常挤压
                   const originalTopRatio = 0; // 巨头没了
                   data.shares.top = 0;
                   data.shares.avg = remaining;
                } else {
                    // 按初始比例挤压
                    const initialTop = config.topComp.share;
                    const initialAvg = 100 - initialTop;
                    const ratio = initialTop / (initialTop + initialAvg);
                    
                    data.shares.top = remaining * ratio;
                    data.shares.avg = remaining * (1 - ratio);
                }

                // 4. 利润计算 (月利润)
                const revenue = data.marketSize * (data.shares.player / 100);
                const profit = revenue * data.margin;
                totalProfit += profit;

                // 5. 估值计算 (简化: 营收 * 5)
                gameState.player.valuation += revenue * 5;

                // 记录图表数据 (保留最近20个点)
                gameState.valuationHistory[role].push(data.marketSize * (data.shares.top / 100) * 5); // 竞对估值
            });

            gameState.valuationHistory.player.push(gameState.player.valuation);
            for (let key in gameState.valuationHistory) {
                if (gameState.valuationHistory[key].length > 20) gameState.valuationHistory[key].shift();
            }

            // 更新总资金
            gameState.player.cash += totalProfit;
            updateCashDisplay(totalProfit);

            // 实时更新 UI
            if (document.getElementById('intel-window').classList.contains('open')) renderIntelContent(gameState.intelTabRole);
            if (document.getElementById('market-window').classList.contains('open')) renderMarketContent();
        }

        // =================== 区域加成逻辑 ===================
        function getRegionBonus(role) {
            // 查找该产业链的分部所在的区域
            const branch = gameState.branches.find(b => b.role === role);
            if (!branch) return { costFactor: 1, rdFactor: 1, compBoost: 1 };
            
            return regionBonuses[branch.regionName] || { costFactor: 1, rdFactor: 1, compBoost: 1 };
        }

        // =================== UI & 资金 ===================
        function updateCashDisplay(profitPerSec) {
            document.getElementById('cash-display').innerText = Math.floor(gameState.player.cash).toLocaleString();
            
            if (profitPerSec !== undefined) {
                const el = document.getElementById('profit-display');
                const val = profitPerSec.toFixed(1);
                if (profitPerSec >= 0) {
                    el.innerText = `+${val} B / month`;
                    el.className = "text-[10px] text-green-500";
                } else {
                    el.innerText = `${val} B / month`;
                    el.className = "text-[10px] text-red-500";
                }
            }
        }

        function spendCash(amount) {
            if (gameState.player.cash >= amount) {
                gameState.player.cash -= amount;
                updateCashDisplay(); 
                return true;
            }
            const display = document.getElementById('cash-display').parentElement;
            display.style.border = "1px solid red";
            setTimeout(() => display.style.border = "1px solid rgba(34, 197, 94, 0.3)", 200);
            return false;
        }

        // =================== 产品发布逻辑 ===================
        function launchProduct() {
            const role = gameState.currentTabRole;
            const name = document.getElementById('product-name').value;
            const score = parseInt(document.getElementById('calc-score').innerText);
            const productPower = parseInt(document.getElementById('calc-power').innerText); // 0-100
            const specs = [1,2,3].map(i => parseInt(document.getElementById(`slider-${i}`).value));
            const marginPercent = parseInt(document.getElementById('calc-margin').innerText);

            gameState.products[role] = { name, specs, score };
            
            // 核心算法:
            // 1. 产品力 (Product Power) 决定市场份额上限 (Cap)
            const cap = productPower; 

            // 2. 竞争力 (Score) 决定实际吃下的比例 (Efficiency)
            // 比如竞争力 100分，吃下 100% 的 Cap。竞争力 50分，吃下 50% 的 Cap。
            const efficiency = score / 100; 
            
            const targetShare = cap * efficiency;
            
            gameState.marketData[role].targetShare = targetShare;
            gameState.marketData[role].margin = marginPercent / 100;

            const btn = document.getElementById('launch-btn');
            const originalText = btn.innerText;
            btn.innerText = "发布成功 / RELEASED!";
            btn.classList.add('bg-white', 'text-black');
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('bg-white', 'text-black');
                toggleProductWindow();
                const newsContent = document.getElementById('news-content');
                newsContent.innerHTML = `<span class="text-white font-bold">新品发布: ${gameState.player.name} 推出了 ${name}! 目标份额: ${targetShare.toFixed(1)}%</span> &nbsp;///&nbsp; ` + newsContent.innerHTML;
            }, 1000);
        }

        // =================== 资本运作 & 收购 ===================
        function toggleMarketWindow() {
            const win = document.getElementById('market-window');
            const isOpen = win.classList.contains('open');
            closeAllWindows();
            if (!isOpen) { 
                win.classList.add('open');
                renderMarketContent();
            }
        }

        function renderMarketContent() {
            // 1. 绘制图表 (简单 SVG 折线)
            const svg = document.getElementById('valuation-chart');
            svg.innerHTML = ""; // Clear
            const history = gameState.valuationHistory;
            const len = history.player.length;
            if (len < 2) return;

            // 找出最大值以缩放
            let maxVal = 100;
            for (let k in history) maxVal = Math.max(maxVal, ...history[k]);
            
            const w = 300, h = 100;
            const dx = w / (len - 1);

            const colors = { player: '#00ff9d', level0: '#ef4444', level1: '#ef4444', level2: '#ef4444', level3: '#ef4444' };
            
            for (let k in history) {
                if (history[k].length === 0) continue;
                let points = "";
                history[k].forEach((val, i) => {
                    const x = i * dx;
                    const y = h - (val / maxVal * h);
                    points += `${x},${y} `;
                });
                const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                polyline.setAttribute("points", points);
                polyline.setAttribute("fill", "none");
                polyline.setAttribute("stroke", colors[k]);
                polyline.setAttribute("stroke-width", k==='player'?2:1);
                if (k !== 'player') polyline.setAttribute("opacity", "0.5");
                svg.appendChild(polyline);
            }

            // 2. 并购列表
            const list = document.getElementById('ma-list');
            let html = "";
            ['level0', 'level1', 'level2', 'level3'].forEach(role => {
                const comp = tierConfig[role].topComp;
                if (comp.acquired) return; // 已收购

                // 估算收购价格: 市场份额 * 市场规模 * 溢价系数 (e.g. 10)
                const valuation = gameState.marketData[role].marketSize * (comp.share / 100) * 10;
                const cost = Math.floor(valuation);

                html += `
                <div class="bg-gray-900 border border-gray-700 p-3 rounded flex justify-between items-center">
                    <div>
                        <div class="text-sm font-bold text-white">${comp.name}</div>
                        <div class="text-[10px] text-gray-500">行业: ${tierConfig[role].short}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-[var(--market-purple)] mb-1">市值 $${cost} B</div>
                        <button class="bg-purple-900 hover:bg-purple-700 text-white text-xs px-3 py-1 rounded border border-purple-500" onclick="acquireCompany('${role}', ${cost})">收购</button>
                    </div>
                </div>`;
            });
            
            if (html === "") html = "<div class='text-gray-500 text-center text-xs'>暂无并购目标</div>";
            list.innerHTML = html;
        }

        function acquireCompany(role, cost) {
            if (!spendCash(cost)) return;

            const config = tierConfig[role];
            config.topComp.acquired = true; // 标记被收购
            
            // 1. 解锁产业链
            gameState.tech[role].unlocked = true;
            
            // 2. 科技树直升 Node 3 (idx 2)
            gameState.tech[role].specs.forEach(s => s.level = 2);

            // 3. 产品转换
            gameState.products[role] = {
                name: config.topComp.flagship + " (Acquired)",
                specs: config.topComp.specs,
                score: config.topComp.score
            };
            
            // 4. 市场份额接管
            gameState.marketData[role].playerShare += config.topComp.share;
            gameState.marketData[role].shares.player += config.topComp.share; // 瞬时
            gameState.marketData[role].targetShare = Math.max(gameState.marketData[role].targetShare, config.topComp.share);
            gameState.marketData[role].margin = 0.3; // 默认利润

            // 5. 地图更新
            const techCompIdx = techCompanies.findIndex(c => c.role === role);
            if (techCompIdx !== -1) {
                const comp = techCompanies[techCompIdx];
                // 添加为玩家分部
                gameState.branches.push({ role: role, coords: comp.coords, regionName: "Global" }); // 简化区域判定
                // 从竞对列表移除 (视觉上通过重绘实现，不删数据以免报错)
            }

            // UI 反馈
            toggleMarketWindow();
            drawMapObjects();
            const newsContent = document.getElementById('news-content');
            newsContent.innerHTML = `<span class="text-[var(--market-purple)] font-bold">重磅收购: ${gameState.player.name} 完成了对 ${config.topComp.name} 的全资收购!</span> &nbsp;///&nbsp; ` + newsContent.innerHTML;
        }

        // =================== 窗口通用 ===================
        function closeAllWindows() {
            document.querySelectorAll('.side-window').forEach(w => w.classList.remove('open'));
        }
        function toggleProductWindow() {
            const win = document.getElementById('product-window'); const isOpen = win.classList.contains('open'); closeAllWindows(); if (!isOpen) { switchProductTab(gameState.player.role); win.classList.add('open'); }
        }
        function toggleTechWindow() {
            const win = document.getElementById('tech-window'); const isOpen = win.classList.contains('open'); closeAllWindows(); if (!isOpen) { switchTechTab(gameState.player.role); win.classList.add('open'); document.getElementById('tech-detail-panel').innerHTML = '<div class="text-center text-gray-500 text-xs">点击上方科技节点查看详细信息...</div>'; }
        }
        function toggleIntelWindow() {
            const win = document.getElementById('intel-window'); const isOpen = win.classList.contains('open'); closeAllWindows(); if (!isOpen) { switchIntelTab(gameState.player.role); win.classList.add('open'); }
        }

        // =================== 情报逻辑 (修复闪烁) ===================
        function switchIntelTab(role) {
            gameState.intelTabRole = role;
            // 切换标签时清空选中状态，除非是同一标签
            if (gameState.selectedCompetitor && gameState.selectedCompetitor.role !== role) {
                gameState.selectedCompetitor = null;
            }
            document.querySelectorAll('#intel-tabs .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('itab-' + role).classList.add('active');
            renderIntelContent(role);
        }

        function renderIntelContent(role) {
            const config = tierConfig[role];
            const isUnlocked = gameState.tech[role].unlocked;
            const mData = gameState.marketData[role];
            
            document.getElementById('market-size-display').innerText = "$" + Math.floor(mData.marketSize) + " B";
            
            const playerShare = mData.shares.player;
            const topShare = mData.shares.top;
            const otherShare = mData.shares.avg; // 已在Tick中归一化
            
            const barContainer = document.getElementById('market-share-bar');
            barContainer.innerHTML = `
                ${config.topComp.acquired ? '' : `<div class="market-bar-segment" style="width:${topShare}%; background:#ef4444; color:white;">${config.topComp.name} ${topShare.toFixed(1)}%</div>`}
                ${playerShare > 0.1 ? `<div class="market-bar-segment" style="width:${playerShare}%; background:var(--primary-green); color:black;">YOU ${playerShare.toFixed(1)}%</div>` : ''}
                <div class="market-bar-segment" style="width:${otherShare}%; background:#333; color:#888;">OTHERS</div>
            `;
            
            const list = document.getElementById('competitor-list');
            let html = "";
            if (!config.topComp.acquired) {
                html += `<div class="company-item" onclick="showCompetitorDetail('${role}', 'top')"><div class="flex justify-between items-center"><span class="text-sm font-bold text-white">${config.topComp.name}</span><span class="text-xs text-red-500">TOP 1</span></div></div>`;
            }
            if (isUnlocked) {
                html += `<div class="company-item" onclick="showCompetitorDetail('${role}', 'player')"><div class="flex justify-between items-center"><span class="text-sm font-bold text-[var(--primary-green)]">${gameState.player.name}</span><span class="text-xs text-[var(--primary-green)]">YOU</span></div></div>`;
            }
            html += `<div class="company-item" onclick="showCompetitorDetail('${role}', 'avg')"><div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-400">行业平均</span></div></div>`;
            
            list.innerHTML = html;

            // 恢复选中状态
            if (gameState.selectedCompetitor && gameState.selectedCompetitor.role === role) {
                showCompetitorDetail(role, gameState.selectedCompetitor.type);
            }
        }

        function showCompetitorDetail(role, type) {
            gameState.selectedCompetitor = { role, type }; // 保存状态
            
            const config = tierConfig[role];
            const panel = document.getElementById('product-detail-panel');
            let data, colorClass;
            
            if (type === 'top') { data = config.topComp; colorClass = "text-red-500"; } 
            else if (type === 'avg') { data = config.avgComp; colorClass = "text-gray-400"; } 
            else if (type === 'player') {
                const product = gameState.products[role];
                if (!product) { panel.innerHTML = `<div class="text-center text-gray-500 text-xs mt-4">尚未发布产品。</div>`; return; }
                data = { name: gameState.player.name, flagship: product.name, specs: product.specs, score: product.score };
                colorClass = "text-[var(--primary-green)]";
            }

            const labels = config.specs;
            let barsHtml = "";
            data.specs.forEach((val, idx) => {
                barsHtml += `<div class="spec-comparison-row"><div class="spec-label">${labels[idx]}</div><div class="spec-bar-bg"><div class="spec-bar-fill" style="width: ${val}%; background-color: ${type==='player'?'#00ff9d':(type==='top'?'#ef4444':'#888')}"></div></div><div class="spec-val">${val}</div></div>`;
            });
            panel.innerHTML = `<div class="flex justify-between items-start mb-3 border-b border-gray-700 pb-2"><div><div class="text-xs text-gray-500">旗舰产品</div><div class="text-lg font-bold text-white">${data.flagship}</div></div><div class="text-right"><div class="text-xs text-gray-500">竞争力</div><div class="text-xl font-bold ${colorClass}">${data.score}</div></div></div><div class="space-y-1">${barsHtml}</div>`;
        }

        // =================== 产品计算逻辑 (双指标) ===================
        function updateProductStats() {
            const role = gameState.currentTabRole;
            const config = tierConfig[role];
            const bonus = getRegionBonus(role);
            
            const vals = [1, 2, 3].map(i => {
                const slider = document.getElementById(`slider-${i}`);
                let v = parseInt(slider.value);
                const limit = parseInt(slider.dataset.maxLimit || 20);
                if (v > limit) { v = limit; slider.value = limit; }
                document.getElementById(`val-spec-${i}`).innerText = v;
                return v;
            });

            let cost = config.calcCost(vals[0], vals[1], vals[2]);
            cost *= bonus.costFactor; // 应用区域成本加成
            
            document.getElementById('calc-cost').innerText = Math.floor(cost);
            updateProfit(vals); // 传参数避免重复读取
        }

        function updateProfit(vals) {
            if (!vals) vals = [1,2,3].map(i => parseInt(document.getElementById(`slider-${i}`).value));
            const role = gameState.currentTabRole;
            const bonus = getRegionBonus(role);
            
            const cost = parseInt(document.getElementById('calc-cost').innerText);
            const price = parseInt(document.getElementById('product-price').value);
            
            const margin = price - cost;
            const marginPercent = price > 0 ? Math.round((margin / price) * 100) : 0;
            const el = document.getElementById('calc-margin');
            el.innerText = marginPercent + "%";
            el.className = "text-lg font-bold " + (marginPercent < 0 ? "text-red-500" : "text-green-400");

            // 1. 产品力 (Product Power) -> 决定上限
            const totalSpec = vals.reduce((a,b)=>a+b, 0);
            const maxPossibleSpec = 300; // 3 * 100
            const powerPercent = Math.min(100, Math.round((totalSpec / maxPossibleSpec) * 100));
            
            // 2. 竞争力 (Competitiveness) -> 决定实际获取
            let score = 0;
            if (price > 0) {
                let valueRatio = (totalSpec * 3) / price; 
                if (price < cost) valueRatio *= 0.8; // 亏本惩罚
                score = Math.min(100, Math.round(valueRatio * 100));
            }
            score = Math.round(score * bonus.compBoost); // 应用区域竞争力加成

            document.getElementById('calc-power').innerText = powerPercent + "%";
            document.getElementById('calc-score').innerText = score;
        }

        // =================== 地图 & 初始化逻辑 ===================
        function initTechData(startRole) {
            const roles = ['level0', 'level1', 'level2', 'level3'];
            roles.forEach(role => { gameState.tech[role] = { unlocked: (role === startRole), specs: [0, 1, 2].map(i => ({ level: 0 })) }; });
        }
        const regionList = document.getElementById('region-list');
        for (const [key, data] of Object.entries(regionsData)) {
            const btn = document.createElement('button');
            btn.className = 'region-select-btn';
            btn.innerHTML = `${data.label} <span class="float-right text-[10px] ${data.class}">[${data.diff}]</span>`;
            btn.onclick = () => { gameState.player.region = key; document.querySelectorAll('.region-select-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); document.getElementById('region-desc').innerText = data.desc; checkReady(); };
            regionList.appendChild(btn);
        }
        function selectRole(roleKey, card) { gameState.player.role = roleKey; document.querySelectorAll('.chain-card').forEach(c => c.classList.remove('selected')); card.classList.add('selected'); checkReady(); }
        function checkReady() { if (document.getElementById('company-name-input').value && gameState.player.region && gameState.player.role) document.getElementById('start-btn').classList.add('ready'); else document.getElementById('start-btn').classList.remove('ready'); }
        document.getElementById('company-name-input').addEventListener('input', (e) => { gameState.player.name = e.target.value; checkReady(); });
        function enterPlacementMode() { initTechData(gameState.player.role); gameState.step = 'placement'; document.getElementById('setup-overlay').style.display = 'none'; document.body.classList.remove('setup-mode'); document.body.classList.add('placement-mode'); document.getElementById('hint-type').innerText = "全球总部"; document.getElementById('hint-region-name').innerText = regionsData[gameState.player.region].label; document.getElementById('placement-hint').style.display = 'block'; updateMapStyles(); }
        function generateTabs() { const roles = ['level0', 'level1', 'level2', 'level3']; let prodTabsHtml = "", techTabsHtml = "", intelTabsHtml = ""; roles.forEach(role => { const name = tierConfig[role].short; prodTabsHtml += `<div class="tab-btn" onclick="switchProductTab('${role}')" id="ptab-${role}">${name}</div>`; techTabsHtml += `<div class="tab-btn" onclick="switchTechTab('${role}')" id="ttab-${role}">${name}</div>`; intelTabsHtml += `<div class="tab-btn" onclick="switchIntelTab('${role}')" id="itab-${role}">${name}</div>`; }); document.getElementById('product-tabs').innerHTML = prodTabsHtml; document.getElementById('tech-tabs').innerHTML = techTabsHtml; document.getElementById('intel-tabs').innerHTML = intelTabsHtml; }
        function switchProductTab(role) { gameState.currentTabRole = role; document.querySelectorAll('#product-tabs .tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('ptab-' + role).classList.add('active'); updateProductUI(role); }
        function updateProductUI(role) { const isUnlocked = gameState.tech[role].unlocked; const mask = document.getElementById('product-locked-mask'); if (!isUnlocked) { mask.style.display = "flex"; return; } mask.style.display = "none"; const config = tierConfig[role]; const techState = gameState.tech[role]; const caps = [20, 50, 70, 100]; [0, 1, 2].forEach(idx => { const maxVal = caps[techState.specs[idx].level]; const slider = document.getElementById(`slider-${idx+1}`); document.getElementById(`label-spec-${idx+1}`).innerText = config.specs[idx]; document.getElementById(`max-spec-${idx+1}`).innerText = maxVal; if (parseInt(slider.value) > maxVal) slider.value = maxVal; const percentage = maxVal; slider.style.background = `linear-gradient(to right, rgba(255, 255, 255, 0.2) ${percentage}%, #111 ${percentage}%)`; slider.dataset.maxLimit = maxVal; }); document.getElementById('product-price').value = config.defaultPrice; updateProductStats(); }
        function switchTechTab(role) { gameState.techTabRole = role; document.querySelectorAll('#tech-tabs .tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('ttab-' + role).classList.add('active'); renderTechTree(role); }
        function renderTechTree(role) { const container = document.getElementById('tech-content'); const techState = gameState.tech[role]; const config = tierConfig[role]; if (!techState.unlocked) { container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center"><div class="text-gray-400 mb-4">该产业链尚未涉足。</div><button class="bg-green-700 hover:bg-green-600 text-white font-bold py-3 px-8 rounded border border-green-500" onclick="unlockSector('${role}')">成立研发机构<br><span class="text-xs font-normal">$${config.unlockCost}</span></button></div>`; return; } let html = `<div class="mb-4 text-xs text-green-400">当前产业分部: 运行中</div>`; config.specs.forEach((specName, specIdx) => { const treeData = config.techTree[specIdx]; const currentLevel = techState.specs[specIdx].level; html += `<div class="tech-row"><div class="tech-label">${specName}<br><span class="text-[9px] text-gray-600">${treeData.name}</span></div><div class="tech-track">`; treeData.nodes.forEach((nodeName, nodeIdx) => { const caps = [20, 50, 70, 100]; let stateClass = "locked"; if (nodeIdx <= currentLevel) stateClass = "unlocked"; else if (nodeIdx === currentLevel + 1) stateClass = "next-unlock"; const isSelected = gameState.selectedTechNode && gameState.selectedTechNode.role === role && gameState.selectedTechNode.specIdx === specIdx && gameState.selectedTechNode.nodeIdx === nodeIdx; if (isSelected) stateClass += " selected-node"; html += `<div class="tech-node-btn ${stateClass}" onclick="selectTechNode('${role}', ${specIdx}, ${nodeIdx})" title="${nodeName}"><span class="text-[9px] leading-tight text-center">${nodeName}</span>${stateClass === 'unlocked' ? `<span class="node-cap text-green-300">Lv.${caps[nodeIdx]}</span>` : ''}</div>`; }); html += `</div></div>`; }); container.innerHTML = html; }
        function selectTechNode(role, specIdx, nodeIdx) { gameState.selectedTechNode = { role, specIdx, nodeIdx }; renderTechTree(role); const treeData = tierConfig[role].techTree[specIdx]; const cost = treeData.costs[nodeIdx]; const currentLevel = gameState.tech[role].specs[specIdx].level; const panel = document.getElementById('tech-detail-panel'); let actionHtml = ""; if (nodeIdx <= currentLevel) actionHtml = `<div class="text-green-500 font-bold border border-green-500 px-3 py-1 rounded text-sm">已掌握 / MASTERED</div>`; else if (nodeIdx === currentLevel + 1) actionHtml = `<div class="flex flex-col items-end"><div class="text-yellow-400 text-sm mb-1">研发费用: $${cost}</div><button class="bg-green-700 hover:bg-green-600 text-white text-xs font-bold py-1 px-4 rounded border border-green-500" onclick="executePurchaseTech('${role}', ${specIdx}, ${nodeIdx}, ${cost})">立即研发</button></div>`; else actionHtml = `<div class="text-gray-600 text-sm border border-gray-700 px-3 py-1 rounded">需前置科技 / LOCKED</div>`; panel.innerHTML = `<div class="flex justify-between items-start w-full"><div class="flex-1 pr-4"><div class="text-white font-bold text-sm mb-1">${treeData.nodes[nodeIdx]} <span class="text-[10px] text-green-400 bg-green-900/30 px-1 rounded">上限 Lv.${[20,50,70,100][nodeIdx]}</span></div><div class="text-xs text-gray-400 leading-relaxed">${treeData.descs[nodeIdx]}</div></div>${actionHtml}</div>`; }
        function executePurchaseTech(role, specIdx, nodeIdx, cost) { 
            const bonus = getRegionBonus(role);
            const finalCost = cost * bonus.rdFactor; // 应用研发费用加成
            if (spendCash(finalCost)) { gameState.tech[role].specs[specIdx].level = nodeIdx; selectTechNode(role, specIdx, nodeIdx); if (document.getElementById('product-window').classList.contains('open') && gameState.currentTabRole === role) updateProductUI(role); } 
        }
        function unlockSector(role) { if (spendCash(tierConfig[role].unlockCost)) { gameState.tech[role].unlocked = true; document.getElementById('tech-window').classList.remove('open'); enterBranchPlacementMode(role); } }
        function enterBranchPlacementMode(role) { gameState.placingBranch = role; gameState.step = 'branch_placement'; document.body.classList.add('branch-mode'); document.getElementById('hint-type').innerText = tierConfig[role].short + "分部"; document.getElementById('hint-region-name').innerText = "全球"; document.getElementById('placement-hint').style.display = 'block'; }

        const width = window.innerWidth; const height = window.innerHeight; const svg = d3.select("#map-container").append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${width} ${height}`); const g = svg.append("g"); const projection = d3.geoNaturalEarth1().scale(width / 5.5).translate([width / 2, height / 2]); const path = d3.geoPath().projection(projection); const zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", (e) => g.attr("transform", e.transform)); svg.call(zoom); let worldDataGlobal, countriesGlobal, idToRegionGlobal; const tooltip = d3.select("#tooltip");
        Promise.all([d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"), d3.json("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.json")]).then(([world, regionData]) => { d3.select("#loading").style("display", "none"); worldDataGlobal = world; countriesGlobal = world.objects.countries; idToRegionGlobal = {}; regionData.forEach(d => { let r = d.region; if (r === "Americas") { if (d["sub-region"] === "Northern America") { r = "North America"; } else if (d["sub-region"] === "Latin America and the Caribbean") { if (d["intermediate-region"] === "South America") r = "South America"; else r = "North America"; } } idToRegionGlobal[d["country-code"].padStart(3, "0")] = r; idToRegionGlobal[parseInt(d["country-code"])] = r; }); idToRegionGlobal["010"] = "Antarctica"; idToRegionGlobal["304"] = "North America"; drawMap(); drawMapObjects(); });
        function drawMap() { const regions = ["North America", "South America", "Europe", "Africa", "Asia", "Oceania", "Antarctica"]; regions.forEach(r => { const merged = topojson.merge(worldDataGlobal, countriesGlobal.geometries.filter(d => { const m = idToRegionGlobal[d.id]; return m === "Americas" ? r === "North America" : m === r; })); merged.regionName = r; g.append("path").datum(merged).attr("class", "region").attr("d", path).attr("fill", "#ccc").on("click", (e, d) => handleMapClick(e, d)).on("mouseover", function(e, d) { if (gameState.step !== 'playing') d3.select(this).style("fill-opacity", 0.4); }).on("mouseout", function() { if (gameState.step === 'playing') d3.select(this).transition().duration(500).style("fill-opacity", 0.15); else updateMapStyles(); }); }); g.append("path").datum(d3.geoGraticule()()).attr("d", path).attr("fill", "none").attr("stroke", "var(--primary-green)").attr("stroke-width", 0.5).attr("stroke-opacity", 0.05).style("pointer-events", "none"); }
        function handleMapClick(event, d) { const transform = d3.zoomTransform(svg.node()); const coords = projection.invert(transform.invert(d3.pointer(event, svg.node()))); if (gameState.step === 'placement') { if (d.regionName === gameState.player.region) startGame(coords); else { document.getElementById('placement-hint').classList.add('animate-bounce'); setTimeout(() => document.getElementById('placement-hint').classList.remove('animate-bounce'), 500); } } else if (gameState.step === 'branch_placement') { gameState.branches.push({ role: gameState.placingBranch, coords: coords, regionName: d.regionName }); drawMapObjects(); gameState.step = 'playing'; document.getElementById('placement-hint').style.display = 'none'; document.body.classList.remove('branch-mode'); toggleTechWindow(); renderTechTree(gameState.placingBranch); } }
        function updateMapStyles() { const colors = { "North America": "#00eaff", "South America": "#00ff88", "Europe": "#b48eff", "Africa": "#ffae00", "Asia": "#ff3366", "Oceania": "#00ccff", "Antarctica": "#5e737d" }; g.selectAll(".region").attr("fill", d => colors[d.regionName]).classed("target-region", d => d && d.regionName === gameState.player.region && gameState.step === 'placement'); }
        function drawMapObjects() { 
            g.selectAll(".tech-group").remove(); g.selectAll(".player-group").remove(); 
            // Draw competitors
            const compNodes = g.selectAll(".tech-group").data(techCompanies).enter().append("g").attr("class", "tech-group").attr("transform", d => `translate(${projection(d.coords)[0]}, ${projection(d.coords)[1]})`).filter(d => projection(d.coords));
            compNodes.each(function(d) { 
                const roleConfig = tierConfig[d.role];
                if (roleConfig && roleConfig.topComp.acquired) return; // Hide acquired companies
                d3.select(this).append("circle").attr("class", "tech-node-pulse").attr("r", 2).style("animation-delay", () => Math.random()*2+"s");
                d3.select(this).append("circle").attr("class", "tech-node-circle").attr("r", 4).on("mouseover", (e, dd) => showTooltip(e, dd)).on("mousemove", moveTooltip).on("mouseout", hideTooltip);
            });
            // Draw player branches
            const playerNodes = g.selectAll(".player-group").data(gameState.branches).enter().append("g").attr("class", "player-group").attr("transform", d => `translate(${projection(d.coords)[0]}, ${projection(d.coords)[1]})`);
            playerNodes.append("circle").attr("class", d => d.role === gameState.player.role ? "tech-node-pulse player-node-pulse" : "tech-node-pulse branch-node-pulse").attr("r", 2);
            playerNodes.append("circle").attr("class", d => d.role === gameState.player.role ? "tech-node-circle player-node-circle" : "tech-node-circle branch-node-circle").attr("r", 6).on("mouseover", (e, d) => showTooltip(e, { name: gameState.player.name, type: d.role === gameState.player.role ? "GLOBAL HQ" : `${tierConfig[d.role].short} BRANCH`, desc: d.role === gameState.player.role ? "公司全球指挥中心" : `专注于 ${tierConfig[d.role].short} 的研发与生产中心` })).on("mousemove", moveTooltip).on("mouseout", hideTooltip);
        }
        function showTooltip(e, d) { tooltip.style("opacity", 1).html(`<div class="border-b border-green-800 pb-1 mb-1 font-bold text-white">${d.name.toUpperCase()}</div><div class="text-[10px] bg-green-900 text-green-300 inline-block px-1 mb-1">${d.type}</div><div class="text-xs text-gray-300">${d.desc}</div>`); }
        function moveTooltip(e) { tooltip.style("left", (e.pageX+20)+"px").style("top", (e.pageY-20)+"px"); }
        function hideTooltip() { tooltip.style("opacity", 0); }
        window.addEventListener("resize", () => svg.attr("viewBox", `0 0 ${window.innerWidth} ${window.innerHeight}`));
    </script>
</body>
</html>
